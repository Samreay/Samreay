<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Evolution of US COVID-19 cases - Samuel Hinton</title><link rel=stylesheet href="https://cosmiccoding.com.au/css/main.min.b842bc4f8d358708f7b5666fe7108ed6474cd18dad036996cd6f85d3bb7b6a42.css" integrity="sha256-uEK8T401hwj3tWZv5xCO1kdM0Y2tA2mWzW+F07t7akI="><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel="shortcut icon" href=https://cosmiccoding.com.au/img/favicon.png type=image/x-icon></head><meta name=description content="Practise with pandas, python and plotly."><meta name=robots content="noodp"><link rel=canonical href=https://cosmiccoding.com.au/tutorials/us_covid_evolution/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cosmiccoding.com.au/tutorials/us_covid_evolution/cover.png"><meta name=twitter:title content="Evolution of US COVID-19 cases"><meta name=twitter:description content="Practise with pandas, python and plotly."><meta property="og:title" content="Evolution of US COVID-19 cases"><meta property="og:description" content="Practise with pandas, python and plotly."><meta property="og:type" content="article"><meta property="og:url" content="https://cosmiccoding.com.au/tutorials/us_covid_evolution/"><meta property="og:image" content="https://cosmiccoding.com.au/tutorials/us_covid_evolution/cover.png"><meta property="article:section" content="tutorials"><meta property="article:published_time" content="2020-07-09T00:00:00+00:00"><meta property="article:modified_time" content="2020-07-09T00:00:00+00:00"><meta property="article:section" content="tutorial"><meta property="article:published_time" content="2020-07-09 00:00:00 +0000 UTC"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Evolution of US COVID-19 cases","genre":"tutorial","url":"https:\/\/cosmiccoding.com.au\/tutorials\/us_covid_evolution\/","datePublished":"2020-07-09 00:00:00 \u002b0000 UTC","description":"Practise with pandas, python and plotly.","author":{"@type":"Person","name":""}}</script><body><div class="flex flex-col min-h-screen overflow-hidden"><header class="absolute w-full z-30"><div class="max-w-6xl mx-auto px-4 sm:px-6"><div class="flex items-center justify-between h-20"><div class="flex-shrink-0 mr-4"><a class=block href=/ aria-label="Samuel Hinton"><h2 class=logo>SRH</h2></a></div><nav class="hidden md:flex md:flex-grow"><ul class="flex flex-grow justify-end flex-wrap items-center"><li><a href=/#books class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">Books</a></li><li><a href=/reviews class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">Reviews</a></li><li><a href=/tutorials class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">Tutorials</a></li><li><a href=/blogs class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">Blog</a></li><li><a href=/#courses class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">Courses</a></li><li><a href=/static/resume/HintonCV.pdf class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">CV</a></li></ul></nav><div class=md:hidden x-data="{ expanded: false }"><button class=hamburger :class="{ 'active': expanded }" @click.stop="expanded = !expanded" aria-controls=mobile-nav :aria-expanded=expanded>
<span class=sr-only>Menu</span><svg class="w-6 h-6 fill-current text-gray-300 hover:text-gray-200 transition duration-150 ease-in-out" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect y="4" width="24" height="2" rx="1"/><rect y="11" width="24" height="2" rx="1"/><rect y="18" width="24" height="2" rx="1"/></svg></button><nav id=mobile-nav class="absolute top-full z-20 left-0 w-full px-4 sm:px-6 overflow-hidden transition-all duration-300 ease-in-out" x-ref=mobileNav :style="expanded ? 'max-height: ' + $refs.mobileNav.scrollHeight + 'px; opacity: 1' : 'max-height: 0; opacity: .8'" @click.away="expanded = false" @keydown.escape.window="expanded = false" x-cloak><ul class="bg-gray-800 px-4 py-2"><li><a href=/#books class="flex text-gray-300 hover:text-gray-200 py-2">Books</a></li><li><a href=/reviews class="flex text-gray-300 hover:text-gray-200 py-2">Reviews</a></li><li><a href=/tutorials class="flex text-gray-300 hover:text-gray-200 py-2">Tutorials</a></li><li><a href=/blogs class="flex text-gray-300 hover:text-gray-200 py-2">Blog</a></li><li><a href=/#courses class="flex text-gray-300 hover:text-gray-200 py-2">Courses</a></li><li><a href=/static/resume/HintonCV.pdf class="flex text-gray-300 hover:text-gray-200 py-2">CV</a></li></ul></nav></div></div></div></header><div class=flex-grow><div id=post-container class="content content-wider blog-post relative"><div class="section-header blog"><h1 class=title>Evolution of US COVID-19 cases</h1><p>6th July 2020</p><p>Practise with pandas, python and plotly.</p></div><div><ul class="grid gap-6 w-full md:grid-cols-2" style=list-style:none;padding-left:0><li><input type=radio id=show-code name=code-toggle value=show-code class="hidden peer" onchange=clickCheckbox(this) required checked>
<label for=show-code class="inline-flex justify-between items-center p-5 w-full text-gray-500 bg-gray-800 rounded-lg border border-gray-200 cursor-pointer peer-checked:border-2 peer-checked:border-main-300 peer-checked:text-white peer-checked:bg-gray-700 hover:text-gray-200 hover:bg-gray-700"><div class="block w-full"><div class="w-full text-center text-lg font-semibold">Show me everything!</div><div class="w-full text-center text-sm">Oh yeah, coding time.</div></div></label></li><li><input type=radio id=hide-code name=code-toggle value=hide-code class="hidden peer" onchange=clickCheckbox(this)>
<label for=hide-code class="inline-flex justify-between items-center p-5 w-full text-gray-500 bg-gray-800 rounded-lg border border-gray-200 cursor-pointer peer-checked:border-2 peer-checked:border-main-300 peer-checked:text-white peer-checked:bg-gray-700 hover:text-gray-200 hover:bg-gray-700"><div class="block w-full"><div class="w-full text-center text-lg font-semibold">Just the plots</div><div class="w-full text-center text-sm">Code is nasty.</div></div></label></li></ul></div><script>function clickCheckbox(e){e.id=="show-code"?document.getElementById("post-container").classList.remove("hide-code"):document.getElementById("post-container").classList.add("hide-code")}</script><p>This plot was first <a href=https://www.reddit.com/r/dataisbeautiful/comments/hl20sz/watch_covid19_spread_throughout_the_continental/>inspired by this absolute masterpiece of a visualisation</a>. I was chatting with <a href=https://github.com/DavidMorton>David Morton</a> about how much work it must have taken (coding up textures, exporting to blender, creating the model, rendering, compositing, loading back into code, annotating, so much work). David then went and <a href=https://github.com/DavidMorton/COVID-19-Analysis>created a python only version of the plot</a>, and I decided I&rsquo;d give it a crack too. We&rsquo;ve used the same data, but the transformations, plotting and output are all different.</p><p>Here&rsquo;s what we&rsquo;ll be making:</p><p><div class=video><video preload=auto playsinline plays-inline controls autoplay loop muted>
<source src=/tutorials/us_covid_evolution/evolution.mp4 type=video/mp4></video></div></p><p>To start, I cloned down the Johns Hopkins <a href=https://github.com/CSSEGISandData/COVID-19>COVID-19 repo</a>. I then added into the <code>root</code> dir shown below both the <a href=https://www.census.gov/data/datasets/time-series/demo/popest/2010s-counties-total.html>population counts</a> for ech county, and the <a href=https://github.com/plotly/datasets/blob/master/geojson-counties-fips.json><code>geojson</code></a> file that allows us to plot said counties.</p><div class=width-77 markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff6ac1>import</span> os
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> pandas <span style=color:#ff6ac1>as</span> pd
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> numpy <span style=color:#ff6ac1>as</span> np
</span></span><span style=display:flex><span><span style=color:#ff6ac1>from</span> matplotlib.colors <span style=color:#ff6ac1>import</span> to_hex
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> matplotlib.pyplot <span style=color:#ff6ac1>as</span> plt
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> cmasher <span style=color:#ff6ac1>as</span> cmr
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> plotly.express <span style=color:#ff6ac1>as</span> px
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> plotly.graph_objects <span style=color:#ff6ac1>as</span> go
</span></span><span style=display:flex><span><span style=color:#ff6ac1>from</span> functools <span style=color:#ff6ac1>import</span> lru_cache
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Dir where you clone out https://github.com/CSSEGISandData/COVID-19</span>
</span></span><span style=display:flex><span>root <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;D:/data/covid/COVID-19/csse_covid_19_data/csse_covid_19_time_series/&#34;</span>
</span></span></code></pre></div></div><p>Then, lets find all the csv files for the US states and load them in.</p><div class=width-76 markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>df <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>join(root, <span style=color:#5af78e>&#34;time_series_covid19_confirmed_US.csv&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#ff5c57>print</span>(df<span style=color:#ff6ac1>.</span>columns)
</span></span></code></pre></div></div><pre><code>Index(['UID', 'iso2', 'iso3', 'code3', 'FIPS', 'Admin2', 'Province_State',
       'Country_Region', 'Lat', 'Long_',
       ...
       '7/17/20', '7/18/20', '7/19/20', '7/20/20', '7/21/20', '7/22/20',
       '7/23/20', '7/24/20', '7/25/20', '7/26/20'],
      dtype='object', length=198)
</code></pre><p>Right, so its sort of pivoted already. But I dont actually want this, because I want smooth interpolation. I want dates on the index, and FIPS on the columns. On top of that, I want the relative increase in number of cases per 100k residents, or we&rsquo;ll just be <a href=https://xkcd.com/1138/>replicating a population map</a>.</p><p>So first, lets get the estimate population of each FIPS:</p><div class="expanded-code width-89" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#78787e># Load the population for each county</span>
</span></span><span style=display:flex><span>df_pop <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>join(root, <span style=color:#5af78e>&#34;co-est2019-alldata.csv&#34;</span>), encoding<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;ISO-8859-1&#34;</span>)
</span></span><span style=display:flex><span>df_pop[<span style=color:#5af78e>&#34;FIPS&#34;</span>] <span style=color:#ff6ac1>=</span> (df_pop[<span style=color:#5af78e>&#34;STATE&#34;</span>] <span style=color:#ff6ac1>*</span> <span style=color:#ff9f43>1000</span> <span style=color:#ff6ac1>+</span> df_pop[<span style=color:#5af78e>&#34;COUNTY&#34;</span>])<span style=color:#ff6ac1>.</span>apply(<span style=color:#5af78e>&#34;</span><span style=color:#5af78e>{:0&gt;5}</span><span style=color:#5af78e>&#34;</span><span style=color:#ff6ac1>.</span>format)
</span></span><span style=display:flex><span>df_pop <span style=color:#ff6ac1>=</span> df_pop[[<span style=color:#5af78e>&#34;FIPS&#34;</span>, <span style=color:#5af78e>&#34;POPESTIMATE2019&#34;</span>]]
</span></span><span style=display:flex><span>df_pop
</span></span></code></pre></div></div><div><table class="table-auto table dataframe"><thead><tr style=text-align:right><th></th><th>FIPS</th><th>POPESTIMATE2019</th></tr></thead><tbody><tr><th>0</th><td>01000</td><td>4903185</td></tr><tr><th>1</th><td>01001</td><td>55869</td></tr><tr><th>2</th><td>01003</td><td>223234</td></tr><tr><th>3</th><td>01005</td><td>24686</td></tr><tr><th>4</th><td>01007</td><td>22394</td></tr><tr><th>...</th><td>...</td><td>...</td></tr><tr><th>3188</th><td>56037</td><td>42343</td></tr><tr><th>3189</th><td>56039</td><td>23464</td></tr><tr><th>3190</th><td>56041</td><td>20226</td></tr><tr><th>3191</th><td>56043</td><td>7805</td></tr><tr><th>3192</th><td>56045</td><td>6927</td></tr></tbody></table><p>3193 rows Ã— 2 columns</p></div><p>Great, lets merge that in. In addition, you know, to melting, converting units and smoothing it out.</p><div class=width-74 markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#78787e># Determine useless columns</span>
</span></span><span style=display:flex><span>drop <span style=color:#ff6ac1>=</span> [x <span style=color:#ff6ac1>for</span> x <span style=color:#ff6ac1>in</span> df<span style=color:#ff6ac1>.</span>columns <span style=color:#ff6ac1>if</span> <span style=color:#5af78e>&#34;/&#34;</span> <span style=color:#ff6ac1>not</span> <span style=color:#ff6ac1>in</span> x <span style=color:#ff6ac1>and</span> x <span style=color:#ff6ac1>!=</span> <span style=color:#5af78e>&#34;FIPS&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Melt it down so we can convert types easily</span>
</span></span><span style=display:flex><span>df2 <span style=color:#ff6ac1>=</span> df<span style=color:#ff6ac1>.</span>drop(columns<span style=color:#ff6ac1>=</span>drop)<span style=color:#ff6ac1>.</span>melt(id_vars<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;FIPS&#34;</span>, var_name<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;date&#34;</span>)<span style=color:#ff6ac1>.</span>dropna()
</span></span><span style=display:flex><span>df2[<span style=color:#5af78e>&#34;date&#34;</span>] <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>to_datetime(df2[<span style=color:#5af78e>&#34;date&#34;</span>])
</span></span><span style=display:flex><span>df2[<span style=color:#5af78e>&#34;FIPS&#34;</span>] <span style=color:#ff6ac1>=</span> df2[<span style=color:#5af78e>&#34;FIPS&#34;</span>]<span style=color:#ff6ac1>.</span>astype(<span style=color:#ff5c57>int</span>)<span style=color:#ff6ac1>.</span>apply(<span style=color:#5af78e>&#34;</span><span style=color:#5af78e>{:0&gt;5}</span><span style=color:#5af78e>&#34;</span><span style=color:#ff6ac1>.</span>format)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Add the populations</span>
</span></span><span style=display:flex><span>df2 <span style=color:#ff6ac1>=</span> df2<span style=color:#ff6ac1>.</span>merge(df_pop, on<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;FIPS&#34;</span>)
</span></span><span style=display:flex><span>df2[<span style=color:#5af78e>&#34;value&#34;</span>] <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>100000</span> <span style=color:#ff6ac1>*</span> df2[<span style=color:#5af78e>&#34;value&#34;</span>] <span style=color:#ff6ac1>/</span> df2[<span style=color:#5af78e>&#34;POPESTIMATE2019&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Pivot and get the difference</span>
</span></span><span style=display:flex><span>df2 <span style=color:#ff6ac1>=</span> df2<span style=color:#ff6ac1>.</span>pivot(columns<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;FIPS&#34;</span>, index<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;date&#34;</span>, values<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;value&#34;</span>)<span style=color:#ff6ac1>.</span>diff(axis<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0</span>)
</span></span><span style=display:flex><span><span style=color:#78787e># Smooth it out a touch and remove some 0 rows</span>
</span></span><span style=display:flex><span>df2 <span style=color:#ff6ac1>=</span> df2<span style=color:#ff6ac1>.</span>rolling(<span style=color:#ff9f43>7</span>)<span style=color:#ff6ac1>.</span>mean()<span style=color:#ff6ac1>.</span>iloc[<span style=color:#ff9f43>50</span>:, :]
</span></span></code></pre></div></div><p>We&rsquo;ve got the data in a format we want. But I&rsquo;ll also want to turn this into a shiny animation, probably around 20 seconds in length or more. At 30FPS, thats 600+ frames. More than we have rows. So time for interpolation!</p><div class=width-69 markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>fr <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>30</span>  <span style=color:#78787e># frame rate</span>
</span></span><span style=display:flex><span>t <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>20</span>  <span style=color:#78787e># seconds</span>
</span></span><span style=display:flex><span>new_index <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>date_range(df2<span style=color:#ff6ac1>.</span>index<span style=color:#ff6ac1>.</span>min(), df2<span style=color:#ff6ac1>.</span>index<span style=color:#ff6ac1>.</span>max(), fr <span style=color:#ff6ac1>*</span> t)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Combine index, interp, remove original index</span>
</span></span><span style=display:flex><span>df3 <span style=color:#ff6ac1>=</span> df2<span style=color:#ff6ac1>.</span>reindex(new_index <span style=color:#ff6ac1>|</span> df2<span style=color:#ff6ac1>.</span>index)<span style=color:#ff6ac1>.</span>interpolate()<span style=color:#ff6ac1>.</span>loc[new_index]
</span></span><span style=display:flex><span>df3<span style=color:#ff6ac1>.</span>iloc[:<span style=color:#ff9f43>5</span>, :<span style=color:#ff9f43>5</span>]
</span></span></code></pre></div></div><div><table class="table-auto table dataframe"><thead><tr style=text-align:right><th>FIPS</th><th>01001</th><th>01003</th><th>01005</th><th>01007</th><th>01009</th></tr></thead><tbody><tr><th>2020-03-12 00:00:00.000000000</th><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>2020-03-12 05:26:56.694490818</th><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>2020-03-12 10:53:53.388981636</th><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>2020-03-12 16:20:50.083472454</th><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>2020-03-12 21:47:46.777963272</th><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr></tbody></table></div><p>Perfect. So now lets make a plot for this:</p><div class="expanded-code width-103" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff9f43>@lru_cache</span>(maxsize<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>get_all_counties</span>():
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>with</span> <span style=color:#ff5c57>open</span>(os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>join(root, <span style=color:#5af78e>&#39;geojson-counties-fips.json&#39;</span>)) <span style=color:#ff6ac1>as</span> f:
</span></span><span style=display:flex><span>        allcounties <span style=color:#ff6ac1>=</span> json<span style=color:#ff6ac1>.</span>load(f)
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> allcounties
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff9f43>@lru_cache</span>(maxsize<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>get_cmap</span>():
</span></span><span style=display:flex><span>    <span style=color:#5af78e>&#34;&#34;&#34; Gets am ember-like cmap with brighter tail &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    cmap <span style=color:#ff6ac1>=</span> plt<span style=color:#ff6ac1>.</span>get_cmap(<span style=color:#5af78e>&#39;cmr.ember&#39;</span>)
</span></span><span style=display:flex><span>    array <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>1</span> <span style=color:#ff6ac1>-</span> cmap(np<span style=color:#ff6ac1>.</span>linspace(<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1</span>, <span style=color:#ff9f43>100</span>))
</span></span><span style=display:flex><span>    brightening <span style=color:#ff6ac1>=</span> np<span style=color:#ff6ac1>.</span>clip(np<span style=color:#ff6ac1>.</span>linspace(<span style=color:#ff6ac1>-</span><span style=color:#ff9f43>10</span>, <span style=color:#ff9f43>3</span>, <span style=color:#ff9f43>100</span>), <span style=color:#ff9f43>1</span>, <span style=color:#ff9f43>4</span>)
</span></span><span style=display:flex><span>    final <span style=color:#ff6ac1>=</span> np<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff9f43>1</span> <span style=color:#ff6ac1>-</span> (array <span style=color:#ff6ac1>/</span> brightening[:, <span style=color:#ff6ac1>None</span>]), <span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> [to_hex(x) <span style=color:#ff6ac1>for</span> x <span style=color:#ff6ac1>in</span> final]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>default_configure</span>(fig, date, vmax, bgcolor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#15171c&#34;</span>):
</span></span><span style=display:flex><span>    <span style=color:#5af78e>&#34;&#34;&#34; Visual styling and labels, ignore this function as its boring &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    fig<span style=color:#ff6ac1>.</span>update_geos(showcountries<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, showcoastlines<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, showframe<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>,
</span></span><span style=display:flex><span>                    oceancolor<span style=color:#ff6ac1>=</span>bgcolor, lakecolor<span style=color:#ff6ac1>=</span>bgcolor, showland<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, showlakes<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, 
</span></span><span style=display:flex><span>                    showocean<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>,subunitcolor<span style=color:#ff6ac1>=</span>bgcolor, landcolor<span style=color:#ff6ac1>=</span>bgcolor, bgcolor<span style=color:#ff6ac1>=</span>bgcolor)
</span></span><span style=display:flex><span>    fig<span style=color:#ff6ac1>.</span>update_traces(marker_line_width<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0</span>, showscale<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>)
</span></span><span style=display:flex><span>    annotations <span style=color:#ff6ac1>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>dict</span>(x<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.03</span>,y<span style=color:#ff6ac1>=-</span><span style=color:#ff9f43>0.03</span>,font<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#635f5d&#34;</span>,size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>12</span>),showarrow<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>,
</span></span><span style=display:flex><span>        text<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;Data from Johns Hopkins COVID-19 DataSet&#39;</span>,
</span></span><span style=display:flex><span>        xref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>,yref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>, yanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;bottom&#34;</span>),
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>dict</span>(x<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1.0</span>,y<span style=color:#ff6ac1>=-</span><span style=color:#ff9f43>0.03</span>,font<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#635f5d&#34;</span>,size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>12</span>),showarrow<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>,
</span></span><span style=display:flex><span>        text<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;Code at https://cosmiccoding.com.au/uscovidevolution&#39;</span>,
</span></span><span style=display:flex><span>        xref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>,yref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>, xanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;right&#34;</span>, yanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;bottom&#34;</span>),
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>dict</span>(x<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.52</span>, y<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1.04</span>, yanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;top&#39;</span>, xanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;center&#39;</span>, font<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>24</span>),
</span></span><span style=display:flex><span>         showarrow<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, text<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;Daily New COVID-19 Cases Per 100k People&#39;</span>, xref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>, yref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>),
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>dict</span>(x<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.52</span>, y<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.95</span>, yanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;top&#39;</span>, xanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;center&#39;</span>, font<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#bfbfbf&#34;</span>, size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>16</span>),
</span></span><span style=display:flex><span>     showarrow<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, text<span style=color:#ff6ac1>=</span>date, xref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>, yref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>)
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>    fig<span style=color:#ff6ac1>.</span>update_layout(plot_bgcolor<span style=color:#ff6ac1>=</span>bgcolor, paper_bgcolor<span style=color:#ff6ac1>=</span>bgcolor,
</span></span><span style=display:flex><span>                      margin<span style=color:#ff6ac1>=</span>{<span style=color:#5af78e>&#34;r&#34;</span>: <span style=color:#ff9f43>20</span>,<span style=color:#5af78e>&#34;t&#34;</span>:<span style=color:#ff9f43>40</span>,<span style=color:#5af78e>&#34;l&#34;</span>:<span style=color:#ff9f43>0</span>,<span style=color:#5af78e>&#34;b&#34;</span>:<span style=color:#ff9f43>20</span>}, annotations<span style=color:#ff6ac1>=</span>annotations,
</span></span><span style=display:flex><span>                     coloraxis_colorbar<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(thicknessmode<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;pixels&#34;</span>, thickness<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>12</span>, ticks<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>                                             tickmode<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;array&#34;</span>, 
</span></span><span style=display:flex><span>                                             ticktext<span style=color:#ff6ac1>=</span>[<span style=color:#5af78e>&#34; 0&#34;</span>, <span style=color:#5af78e>f</span><span style=color:#5af78e>&#34; </span><span style=color:#5af78e>{</span><span style=color:#ff5c57>int</span>(vmax <span style=color:#ff6ac1>/</span> <span style=color:#ff9f43>2</span>)<span style=color:#5af78e>}</span><span style=color:#5af78e>&#34;</span>, <span style=color:#5af78e>f</span><span style=color:#5af78e>&#34; </span><span style=color:#5af78e>{</span>vmax<span style=color:#5af78e>}</span><span style=color:#5af78e>+&#34;</span>], 
</span></span><span style=display:flex><span>                                             tickvals<span style=color:#ff6ac1>=</span>[<span style=color:#ff9f43>0</span>, <span style=color:#ff5c57>int</span>(vmax<span style=color:#ff6ac1>/</span><span style=color:#ff9f43>2</span>), <span style=color:#ff9f43>0.97</span> <span style=color:#ff6ac1>*</span> vmax],
</span></span><span style=display:flex><span>                                             x<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.92</span>, y<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.5</span>,
</span></span><span style=display:flex><span>                                             tickfont<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>16</span>),
</span></span><span style=display:flex><span>                                             <span style=color:#ff5c57>len</span><span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.65</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>save_fig</span>(fig, n):
</span></span><span style=display:flex><span>    out <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;us_covid_evolution/png&#34;</span>
</span></span><span style=display:flex><span>    os<span style=color:#ff6ac1>.</span>makedirs(out, exist_ok<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>True</span>)
</span></span><span style=display:flex><span>    fig<span style=color:#ff6ac1>.</span>write_image(os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>join(out, <span style=color:#5af78e>f</span><span style=color:#5af78e>&#34;</span><span style=color:#5af78e>{</span>n<span style=color:#5af78e>:</span><span style=color:#5af78e>0&gt;4</span><span style=color:#5af78e>}</span><span style=color:#5af78e>.png&#34;</span>), scale<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>plot_row</span>(df, row, vmax<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>50</span>, show<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>):
</span></span><span style=display:flex><span>    tmp <span style=color:#ff6ac1>=</span> df<span style=color:#ff6ac1>.</span>iloc[row, :]<span style=color:#ff6ac1>.</span>T<span style=color:#ff6ac1>.</span>reset_index()
</span></span><span style=display:flex><span>    date <span style=color:#ff6ac1>=</span> tmp<span style=color:#ff6ac1>.</span>columns[<span style=color:#ff9f43>1</span>]<span style=color:#ff6ac1>.</span>strftime(<span style=color:#5af78e>&#34;</span><span style=color:#5af78e>%d</span><span style=color:#5af78e> - %B&#34;</span>)
</span></span><span style=display:flex><span>    tmp<span style=color:#ff6ac1>.</span>columns <span style=color:#ff6ac1>=</span> [<span style=color:#5af78e>&#34;FIPS&#34;</span>, <span style=color:#5af78e>&#34;c&#34;</span>]
</span></span><span style=display:flex><span>    fig <span style=color:#ff6ac1>=</span> px<span style=color:#ff6ac1>.</span>choropleth(tmp, geojson<span style=color:#ff6ac1>=</span>get_all_counties(), locations<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;FIPS&#39;</span>, 
</span></span><span style=display:flex><span>                        color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;c&#34;</span>, color_continuous_scale<span style=color:#ff6ac1>=</span>get_cmap(), labels<span style=color:#ff6ac1>=</span>{<span style=color:#5af78e>&#34;c&#34;</span>: <span style=color:#5af78e>&#34;&#34;</span>},
</span></span><span style=display:flex><span>                        scope<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;usa&#34;</span>, range_color<span style=color:#ff6ac1>=</span>(<span style=color:#ff9f43>0</span>, vmax), template<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;plotly_dark&#39;</span>)
</span></span><span style=display:flex><span>    default_configure(fig, date, vmax)
</span></span><span style=display:flex><span>    save_fig(fig, row)
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>if</span> show:
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> fig
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#78787e># Lets just plot the final frame to make sure it looks good   </span>
</span></span><span style=display:flex><span>n <span style=color:#ff6ac1>=</span> df3<span style=color:#ff6ac1>.</span>shape[<span style=color:#ff9f43>0</span>] <span style=color:#ff6ac1>-</span> <span style=color:#ff9f43>1</span>
</span></span><span style=display:flex><span>fig <span style=color:#ff6ac1>=</span> plot_row(df3, n, show<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Want a PNG, not interactive</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>from</span> IPython.display <span style=color:#ff6ac1>import</span> Image
</span></span><span style=display:flex><span>Image(fig<span style=color:#ff6ac1>.</span>to_image(<span style=color:#ff5c57>format</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;png&#34;</span>, scale<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>2</span>))
</span></span></code></pre></div></div><p><div><figure class="img-main poster rounded"><picture><source srcset=/tutorials/us_covid_evolution/cover_huf38146b19f69c9d05dd7c5d3b230c344_415912_1400x0_resize_q90_h2_box_3.webp width=1400 height=1000 type=image/webp><source srcset=/tutorials/us_covid_evolution/cover.png width=1400 height=1000 type=image/png><img width=1400 height=1000 loading=lazy decoding=async alt=png src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mPMn7vLFAAFRgH97g1QygAAAABJRU5ErkJggg=="></picture></figure></div></p><p>What an image! Now to save out a whole bunch of images. I&rsquo;m doing this in a notebook, but <code>joblib</code> still works with the threading back end.</p><div class="expanded-code width-93" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff6ac1>from</span> joblib <span style=color:#ff6ac1>import</span> Parallel, delayed
</span></span><span style=display:flex><span>Parallel(prefer<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;threads&#34;</span>, n_jobs<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>4</span>)(delayed(plot_row)(df3, n) <span style=color:#ff6ac1>for</span> n <span style=color:#ff6ac1>in</span> <span style=color:#ff5c57>range</span>(df3<span style=color:#ff6ac1>.</span>shape[<span style=color:#ff9f43>0</span>]));
</span></span></code></pre></div></div><p>And now that we have a PNG sequence, lets render it out to an mp4 file. Im going to also add a mask (which is black but transparent over the country and colorbar that I want to glow, I threw it together in photoshop) and some complex filters to emulate a glow effect without having to throw it in After Effects, and it also makes it pause on the last frame for a bit without having to rend out things over and over.</p><div class="expanded-code width-121" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ffmpeg -r 30 -i us_covid_evolution/png/%04d.png -i us_covid_evolution/mask.png -filter_complex &#34;      [1]setsar=sar=0[p],
</span></span><span style=display:flex><span>[0]split[a][b],
</span></span><span style=display:flex><span>[a][p]overlay,lumakey=0:tolerance=0.5:softness=0.5[x];
</span></span><span style=display:flex><span>color=black,format=rgb24[c];
</span></span><span style=display:flex><span>[c][x]scale2ref[c][i];
</span></span><span style=display:flex><span>[c][i]overlay=format=auto:shortest=1,
</span></span><span style=display:flex><span>setsar=sar=1,
</span></span><span style=display:flex><span>gblur=30:3,
</span></span><span style=display:flex><span>curves=all=&#39;0/0 1/1&#39;[d],
</span></span><span style=display:flex><span>[b]setsar=sar=1[e],
</span></span><span style=display:flex><span>[d][e]blend=all_mode=addition,
</span></span><span style=display:flex><span>scale=1920:-2,
</span></span><span style=display:flex><span>tpad=stop_mode=clone:stop_duration=4
</span></span><span style=display:flex><span>&#34; -vcodec libx264 -crf 23 -movflags faststart -pix_fmt yuv420p us_covid_evolution/evolution.mp4
</span></span></code></pre></div></div><p>For a super brief explanation of the <code>-filter_complex</code>:</p><ul><li>Load in the mask and overlay it on the image so that the black &ldquo;blacks-out&rdquo; the parts I dont want</li><li>lumakey then makes sure anything dim becomes transparent, so it wont glow</li><li>Merge a black solid on top</li><li>Apply a guassian glur</li><li>Intensity the blurred image</li><li>Add it on top of the original image</li><li>Rescale it to 1920 pixels wide</li><li>Add 2 seconds of video at the end which is the last frame frozen out.</li></ul><p>After that has run, we should have a nice animated version of the PNG sequence! In fact, I&rsquo;ll put the video up the top as well. If you dont want the glow, the entire filter can just be the scaling the the <code>tpad</code>, much simpler. Heres the final product:</p><p><div class=video><video preload=auto playsinline plays-inline controls autoplay loop muted>
<source src=/tutorials/us_covid_evolution/evolution.mp4 type=video/mp4></video></div></p><hr><p>For your convenience, here&rsquo;s the code in one block:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff6ac1>import</span> os
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> pandas <span style=color:#ff6ac1>as</span> pd
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> numpy <span style=color:#ff6ac1>as</span> np
</span></span><span style=display:flex><span><span style=color:#ff6ac1>from</span> matplotlib.colors <span style=color:#ff6ac1>import</span> to_hex
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> matplotlib.pyplot <span style=color:#ff6ac1>as</span> plt
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> cmasher <span style=color:#ff6ac1>as</span> cmr
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> plotly.express <span style=color:#ff6ac1>as</span> px
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> plotly.graph_objects <span style=color:#ff6ac1>as</span> go
</span></span><span style=display:flex><span><span style=color:#ff6ac1>from</span> functools <span style=color:#ff6ac1>import</span> lru_cache
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Dir where you clone out https://github.com/CSSEGISandData/COVID-19</span>
</span></span><span style=display:flex><span>root <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;D:/data/covid/COVID-19/csse_covid_19_data/csse_covid_19_time_series/&#34;</span>
</span></span><span style=display:flex><span>df <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>join(root, <span style=color:#5af78e>&#34;time_series_covid19_confirmed_US.csv&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#ff5c57>print</span>(df<span style=color:#ff6ac1>.</span>columns)
</span></span><span style=display:flex><span><span style=color:#78787e># Load the population for each county</span>
</span></span><span style=display:flex><span>df_pop <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>join(root, <span style=color:#5af78e>&#34;co-est2019-alldata.csv&#34;</span>), encoding<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;ISO-8859-1&#34;</span>)
</span></span><span style=display:flex><span>df_pop[<span style=color:#5af78e>&#34;FIPS&#34;</span>] <span style=color:#ff6ac1>=</span> (df_pop[<span style=color:#5af78e>&#34;STATE&#34;</span>] <span style=color:#ff6ac1>*</span> <span style=color:#ff9f43>1000</span> <span style=color:#ff6ac1>+</span> df_pop[<span style=color:#5af78e>&#34;COUNTY&#34;</span>])<span style=color:#ff6ac1>.</span>apply(<span style=color:#5af78e>&#34;</span><span style=color:#5af78e>{:0&gt;5}</span><span style=color:#5af78e>&#34;</span><span style=color:#ff6ac1>.</span>format)
</span></span><span style=display:flex><span>df_pop <span style=color:#ff6ac1>=</span> df_pop[[<span style=color:#5af78e>&#34;FIPS&#34;</span>, <span style=color:#5af78e>&#34;POPESTIMATE2019&#34;</span>]]
</span></span><span style=display:flex><span>df_pop
</span></span><span style=display:flex><span><span style=color:#78787e># Determine useless columns</span>
</span></span><span style=display:flex><span>drop <span style=color:#ff6ac1>=</span> [x <span style=color:#ff6ac1>for</span> x <span style=color:#ff6ac1>in</span> df<span style=color:#ff6ac1>.</span>columns <span style=color:#ff6ac1>if</span> <span style=color:#5af78e>&#34;/&#34;</span> <span style=color:#ff6ac1>not</span> <span style=color:#ff6ac1>in</span> x <span style=color:#ff6ac1>and</span> x <span style=color:#ff6ac1>!=</span> <span style=color:#5af78e>&#34;FIPS&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Melt it down so we can convert types easily</span>
</span></span><span style=display:flex><span>df2 <span style=color:#ff6ac1>=</span> df<span style=color:#ff6ac1>.</span>drop(columns<span style=color:#ff6ac1>=</span>drop)<span style=color:#ff6ac1>.</span>melt(id_vars<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;FIPS&#34;</span>, var_name<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;date&#34;</span>)<span style=color:#ff6ac1>.</span>dropna()
</span></span><span style=display:flex><span>df2[<span style=color:#5af78e>&#34;date&#34;</span>] <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>to_datetime(df2[<span style=color:#5af78e>&#34;date&#34;</span>])
</span></span><span style=display:flex><span>df2[<span style=color:#5af78e>&#34;FIPS&#34;</span>] <span style=color:#ff6ac1>=</span> df2[<span style=color:#5af78e>&#34;FIPS&#34;</span>]<span style=color:#ff6ac1>.</span>astype(<span style=color:#ff5c57>int</span>)<span style=color:#ff6ac1>.</span>apply(<span style=color:#5af78e>&#34;</span><span style=color:#5af78e>{:0&gt;5}</span><span style=color:#5af78e>&#34;</span><span style=color:#ff6ac1>.</span>format)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Add the populations</span>
</span></span><span style=display:flex><span>df2 <span style=color:#ff6ac1>=</span> df2<span style=color:#ff6ac1>.</span>merge(df_pop, on<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;FIPS&#34;</span>)
</span></span><span style=display:flex><span>df2[<span style=color:#5af78e>&#34;value&#34;</span>] <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>100000</span> <span style=color:#ff6ac1>*</span> df2[<span style=color:#5af78e>&#34;value&#34;</span>] <span style=color:#ff6ac1>/</span> df2[<span style=color:#5af78e>&#34;POPESTIMATE2019&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Pivot and get the difference</span>
</span></span><span style=display:flex><span>df2 <span style=color:#ff6ac1>=</span> df2<span style=color:#ff6ac1>.</span>pivot(columns<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;FIPS&#34;</span>, index<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;date&#34;</span>, values<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;value&#34;</span>)<span style=color:#ff6ac1>.</span>diff(axis<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0</span>)
</span></span><span style=display:flex><span><span style=color:#78787e># Smooth it out a touch and remove some 0 rows</span>
</span></span><span style=display:flex><span>df2 <span style=color:#ff6ac1>=</span> df2<span style=color:#ff6ac1>.</span>rolling(<span style=color:#ff9f43>7</span>)<span style=color:#ff6ac1>.</span>mean()<span style=color:#ff6ac1>.</span>iloc[<span style=color:#ff9f43>50</span>:, :]
</span></span><span style=display:flex><span>fr <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>30</span>  <span style=color:#78787e># frame rate</span>
</span></span><span style=display:flex><span>t <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>20</span>  <span style=color:#78787e># seconds</span>
</span></span><span style=display:flex><span>new_index <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>date_range(df2<span style=color:#ff6ac1>.</span>index<span style=color:#ff6ac1>.</span>min(), df2<span style=color:#ff6ac1>.</span>index<span style=color:#ff6ac1>.</span>max(), fr <span style=color:#ff6ac1>*</span> t)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Combine index, interp, remove original index</span>
</span></span><span style=display:flex><span>df3 <span style=color:#ff6ac1>=</span> df2<span style=color:#ff6ac1>.</span>reindex(new_index <span style=color:#ff6ac1>|</span> df2<span style=color:#ff6ac1>.</span>index)<span style=color:#ff6ac1>.</span>interpolate()<span style=color:#ff6ac1>.</span>loc[new_index]
</span></span><span style=display:flex><span>df3<span style=color:#ff6ac1>.</span>iloc[:<span style=color:#ff9f43>5</span>, :<span style=color:#ff9f43>5</span>]
</span></span><span style=display:flex><span><span style=color:#ff9f43>@lru_cache</span>(maxsize<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>get_all_counties</span>():
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>with</span> <span style=color:#ff5c57>open</span>(os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>join(root, <span style=color:#5af78e>&#39;geojson-counties-fips.json&#39;</span>)) <span style=color:#ff6ac1>as</span> f:
</span></span><span style=display:flex><span>        allcounties <span style=color:#ff6ac1>=</span> json<span style=color:#ff6ac1>.</span>load(f)
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> allcounties
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff9f43>@lru_cache</span>(maxsize<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>get_cmap</span>():
</span></span><span style=display:flex><span>    <span style=color:#5af78e>&#34;&#34;&#34; Gets am ember-like cmap with brighter tail &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    cmap <span style=color:#ff6ac1>=</span> plt<span style=color:#ff6ac1>.</span>get_cmap(<span style=color:#5af78e>&#39;cmr.ember&#39;</span>)
</span></span><span style=display:flex><span>    array <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>1</span> <span style=color:#ff6ac1>-</span> cmap(np<span style=color:#ff6ac1>.</span>linspace(<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1</span>, <span style=color:#ff9f43>100</span>))
</span></span><span style=display:flex><span>    brightening <span style=color:#ff6ac1>=</span> np<span style=color:#ff6ac1>.</span>clip(np<span style=color:#ff6ac1>.</span>linspace(<span style=color:#ff6ac1>-</span><span style=color:#ff9f43>10</span>, <span style=color:#ff9f43>3</span>, <span style=color:#ff9f43>100</span>), <span style=color:#ff9f43>1</span>, <span style=color:#ff9f43>4</span>)
</span></span><span style=display:flex><span>    final <span style=color:#ff6ac1>=</span> np<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff9f43>1</span> <span style=color:#ff6ac1>-</span> (array <span style=color:#ff6ac1>/</span> brightening[:, <span style=color:#ff6ac1>None</span>]), <span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> [to_hex(x) <span style=color:#ff6ac1>for</span> x <span style=color:#ff6ac1>in</span> final]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>default_configure</span>(fig, date, vmax, bgcolor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#15171c&#34;</span>):
</span></span><span style=display:flex><span>    <span style=color:#5af78e>&#34;&#34;&#34; Visual styling and labels, ignore this function as its boring &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    fig<span style=color:#ff6ac1>.</span>update_geos(showcountries<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, showcoastlines<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, showframe<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>,
</span></span><span style=display:flex><span>                    oceancolor<span style=color:#ff6ac1>=</span>bgcolor, lakecolor<span style=color:#ff6ac1>=</span>bgcolor, showland<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, showlakes<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, 
</span></span><span style=display:flex><span>                    showocean<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>,subunitcolor<span style=color:#ff6ac1>=</span>bgcolor, landcolor<span style=color:#ff6ac1>=</span>bgcolor, bgcolor<span style=color:#ff6ac1>=</span>bgcolor)
</span></span><span style=display:flex><span>    fig<span style=color:#ff6ac1>.</span>update_traces(marker_line_width<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0</span>, showscale<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>)
</span></span><span style=display:flex><span>    annotations <span style=color:#ff6ac1>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>dict</span>(x<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.03</span>,y<span style=color:#ff6ac1>=-</span><span style=color:#ff9f43>0.03</span>,font<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#635f5d&#34;</span>,size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>12</span>),showarrow<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>,
</span></span><span style=display:flex><span>        text<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;Data from Johns Hopkins COVID-19 DataSet&#39;</span>,
</span></span><span style=display:flex><span>        xref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>,yref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>, yanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;bottom&#34;</span>),
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>dict</span>(x<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1.0</span>,y<span style=color:#ff6ac1>=-</span><span style=color:#ff9f43>0.03</span>,font<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#635f5d&#34;</span>,size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>12</span>),showarrow<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>,
</span></span><span style=display:flex><span>        text<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;Code at https://cosmiccoding.com.au/uscovidevolution&#39;</span>,
</span></span><span style=display:flex><span>        xref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>,yref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>, xanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;right&#34;</span>, yanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;bottom&#34;</span>),
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>dict</span>(x<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.52</span>, y<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1.04</span>, yanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;top&#39;</span>, xanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;center&#39;</span>, font<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>24</span>),
</span></span><span style=display:flex><span>         showarrow<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, text<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;Daily New COVID-19 Cases Per 100k People&#39;</span>, xref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>, yref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>),
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>dict</span>(x<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.52</span>, y<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.95</span>, yanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;top&#39;</span>, xanchor<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;center&#39;</span>, font<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#bfbfbf&#34;</span>, size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>16</span>),
</span></span><span style=display:flex><span>     showarrow<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, text<span style=color:#ff6ac1>=</span>date, xref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>, yref<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;paper&#34;</span>)
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>    fig<span style=color:#ff6ac1>.</span>update_layout(plot_bgcolor<span style=color:#ff6ac1>=</span>bgcolor, paper_bgcolor<span style=color:#ff6ac1>=</span>bgcolor,
</span></span><span style=display:flex><span>                      margin<span style=color:#ff6ac1>=</span>{<span style=color:#5af78e>&#34;r&#34;</span>: <span style=color:#ff9f43>20</span>,<span style=color:#5af78e>&#34;t&#34;</span>:<span style=color:#ff9f43>40</span>,<span style=color:#5af78e>&#34;l&#34;</span>:<span style=color:#ff9f43>0</span>,<span style=color:#5af78e>&#34;b&#34;</span>:<span style=color:#ff9f43>20</span>}, annotations<span style=color:#ff6ac1>=</span>annotations,
</span></span><span style=display:flex><span>                     coloraxis_colorbar<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(thicknessmode<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;pixels&#34;</span>, thickness<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>12</span>, ticks<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>                                             tickmode<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;array&#34;</span>, 
</span></span><span style=display:flex><span>                                             ticktext<span style=color:#ff6ac1>=</span>[<span style=color:#5af78e>&#34; 0&#34;</span>, <span style=color:#5af78e>f</span><span style=color:#5af78e>&#34; </span><span style=color:#5af78e>{</span><span style=color:#ff5c57>int</span>(vmax <span style=color:#ff6ac1>/</span> <span style=color:#ff9f43>2</span>)<span style=color:#5af78e>}</span><span style=color:#5af78e>&#34;</span>, <span style=color:#5af78e>f</span><span style=color:#5af78e>&#34; </span><span style=color:#5af78e>{</span>vmax<span style=color:#5af78e>}</span><span style=color:#5af78e>+&#34;</span>], 
</span></span><span style=display:flex><span>                                             tickvals<span style=color:#ff6ac1>=</span>[<span style=color:#ff9f43>0</span>, <span style=color:#ff5c57>int</span>(vmax<span style=color:#ff6ac1>/</span><span style=color:#ff9f43>2</span>), <span style=color:#ff9f43>0.97</span> <span style=color:#ff6ac1>*</span> vmax],
</span></span><span style=display:flex><span>                                             x<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.92</span>, y<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.5</span>,
</span></span><span style=display:flex><span>                                             tickfont<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>dict</span>(size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>16</span>),
</span></span><span style=display:flex><span>                                             <span style=color:#ff5c57>len</span><span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.65</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>save_fig</span>(fig, n):
</span></span><span style=display:flex><span>    out <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;us_covid_evolution/png&#34;</span>
</span></span><span style=display:flex><span>    os<span style=color:#ff6ac1>.</span>makedirs(out, exist_ok<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>True</span>)
</span></span><span style=display:flex><span>    fig<span style=color:#ff6ac1>.</span>write_image(os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>join(out, <span style=color:#5af78e>f</span><span style=color:#5af78e>&#34;</span><span style=color:#5af78e>{</span>n<span style=color:#5af78e>:</span><span style=color:#5af78e>0&gt;4</span><span style=color:#5af78e>}</span><span style=color:#5af78e>.png&#34;</span>), scale<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>plot_row</span>(df, row, vmax<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>50</span>, show<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>):
</span></span><span style=display:flex><span>    tmp <span style=color:#ff6ac1>=</span> df<span style=color:#ff6ac1>.</span>iloc[row, :]<span style=color:#ff6ac1>.</span>T<span style=color:#ff6ac1>.</span>reset_index()
</span></span><span style=display:flex><span>    date <span style=color:#ff6ac1>=</span> tmp<span style=color:#ff6ac1>.</span>columns[<span style=color:#ff9f43>1</span>]<span style=color:#ff6ac1>.</span>strftime(<span style=color:#5af78e>&#34;</span><span style=color:#5af78e>%d</span><span style=color:#5af78e> - %B&#34;</span>)
</span></span><span style=display:flex><span>    tmp<span style=color:#ff6ac1>.</span>columns <span style=color:#ff6ac1>=</span> [<span style=color:#5af78e>&#34;FIPS&#34;</span>, <span style=color:#5af78e>&#34;c&#34;</span>]
</span></span><span style=display:flex><span>    fig <span style=color:#ff6ac1>=</span> px<span style=color:#ff6ac1>.</span>choropleth(tmp, geojson<span style=color:#ff6ac1>=</span>get_all_counties(), locations<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;FIPS&#39;</span>, 
</span></span><span style=display:flex><span>                        color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;c&#34;</span>, color_continuous_scale<span style=color:#ff6ac1>=</span>get_cmap(), labels<span style=color:#ff6ac1>=</span>{<span style=color:#5af78e>&#34;c&#34;</span>: <span style=color:#5af78e>&#34;&#34;</span>},
</span></span><span style=display:flex><span>                        scope<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;usa&#34;</span>, range_color<span style=color:#ff6ac1>=</span>(<span style=color:#ff9f43>0</span>, vmax), template<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;plotly_dark&#39;</span>)
</span></span><span style=display:flex><span>    default_configure(fig, date, vmax)
</span></span><span style=display:flex><span>    save_fig(fig, row)
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>if</span> show:
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> fig
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#78787e># Lets just plot the final frame to make sure it looks good   </span>
</span></span><span style=display:flex><span>n <span style=color:#ff6ac1>=</span> df3<span style=color:#ff6ac1>.</span>shape[<span style=color:#ff9f43>0</span>] <span style=color:#ff6ac1>-</span> <span style=color:#ff9f43>1</span>
</span></span><span style=display:flex><span>fig <span style=color:#ff6ac1>=</span> plot_row(df3, n, show<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Want a PNG, not interactive</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>from</span> IPython.display <span style=color:#ff6ac1>import</span> Image
</span></span><span style=display:flex><span>Image(fig<span style=color:#ff6ac1>.</span>to_image(<span style=color:#ff5c57>format</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;png&#34;</span>, scale<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>2</span>))
</span></span><span style=display:flex><span><span style=color:#ff6ac1>from</span> joblib <span style=color:#ff6ac1>import</span> Parallel, delayed
</span></span><span style=display:flex><span>Parallel(prefer<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;threads&#34;</span>, n_jobs<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>4</span>)(delayed(plot_row)(df3, n) <span style=color:#ff6ac1>for</span> n <span style=color:#ff6ac1>in</span> <span style=color:#ff5c57>range</span>(df3<span style=color:#ff6ac1>.</span>shape[<span style=color:#ff9f43>0</span>]));
</span></span></code></pre></div><div class="relative max-w-xl mx-auto my-20"><div class="fancy_card horizontal"><div class=card_translator><div class="card_rotator tiny_rot card_layer"><div class="card_layer newsletter p-2"><div class="newsletter-inner h-full"><div class="relative h-full sib-form-container" id=sib-form-container><div class="mb-6 lg:mb-12 text-center"><h3 class="text-main-200 mb-2 lg:mb-8">Stay in the loop!</h3><p class="text-main-100 text-lg text-opacity-70">For new releases, exclusive giveaways, and reviews.</p></div><form action="https://Cosmiccoding.us5.list-manage.com/subscribe/post?u=aebe5de1d2e40dccb3aeca491&id=3987dd4a1f" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class="validate w-full" target=_blank novalidate><div><input type=email class="w-full appearance-none bg-main-600 mb-4 border border-main-600 bg-opacity-5 focus:border-main-300 rounded-sm px-4 py-3 text-main-100 placeholder-main-100 required" placeholder="Your best emailâ€¦" aria-label="Your best emailâ€¦" name=EMAIL required data-required=true id=EMAIL><div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_aebe5de1d2e40dccb3aeca491_3987dd4a1f tabindex=-1></div><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class="button btn bg-main-600 hover:bg-main-400 shadow w-full"></div><p id=mce-error-response style=display:none class="text-center mt-2 opacity-50 text-main-200">There was a problem, please try again.</p><p id=mce-success-response style=display:none class="text-center mt-2 opacity-50 text-main-200">Thanks mate, won't let ya down.</p></form></div></div></div><div class="card_layer card_effect card_soft_glare" style=pointer-events:none></div></div></div></div></div></div></div><script language=javascript type=text/javascript src=https://cosmiccoding.com.au/js/main.min.11673d10a962fb5205229607e62ea1d23424d35dad33db7bfe2a09a63d5409fa.js></script>
<script async defer src="https://www.googletagmanager.com/gtag/js?id=G-GRX6QE03YR"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GRX6QE03YR")</script></div></body></html>