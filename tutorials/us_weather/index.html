<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Which Big City has the best Weather? - Samuel Hinton</title><link rel=stylesheet href="https://cosmiccoding.com.au/css/main.min.b842bc4f8d358708f7b5666fe7108ed6474cd18dad036996cd6f85d3bb7b6a42.css" integrity="sha256-uEK8T401hwj3tWZv5xCO1kdM0Y2tA2mWzW+F07t7akI="><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel="shortcut icon" href=https://cosmiccoding.com.au/img/favicon.png type=image/x-icon></head><meta name=description content="Python Plotting Preferred Weather"><meta name=robots content="noodp"><link rel=canonical href=https://cosmiccoding.com.au/tutorials/us_weather/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cosmiccoding.com.au/tutorials/us_weather/cover.png"><meta name=twitter:title content="Which Big City has the best Weather?"><meta name=twitter:description content="Python Plotting Preferred Weather"><meta property="og:title" content="Which Big City has the best Weather?"><meta property="og:description" content="Python Plotting Preferred Weather"><meta property="og:type" content="article"><meta property="og:url" content="https://cosmiccoding.com.au/tutorials/us_weather/"><meta property="og:image" content="https://cosmiccoding.com.au/tutorials/us_weather/cover.png"><meta property="article:section" content="tutorials"><meta property="article:published_time" content="2020-07-06T00:00:00+00:00"><meta property="article:modified_time" content="2020-07-06T00:00:00+00:00"><meta property="article:section" content="tutorial"><meta property="article:published_time" content="2020-07-06 00:00:00 +0000 UTC"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Which Big City has the best Weather?","genre":"tutorial","url":"https:\/\/cosmiccoding.com.au\/tutorials\/us_weather\/","datePublished":"2020-07-06 00:00:00 \u002b0000 UTC","description":"Python Plotting Preferred Weather","author":{"@type":"Person","name":""}}</script><body><div class="flex flex-col min-h-screen overflow-hidden"><header class="absolute w-full z-30"><div class="max-w-6xl mx-auto px-4 sm:px-6"><div class="flex items-center justify-between h-20"><div class="flex-shrink-0 mr-4"><a class=block href=/ aria-label="Samuel Hinton"><h2 class=logo>SRH</h2></a></div><nav class="hidden md:flex md:flex-grow"><ul class="flex flex-grow justify-end flex-wrap items-center"><li><a href=/#books class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">Books</a></li><li><a href=/reviews class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">Reviews</a></li><li><a href=/tutorials class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">Tutorials</a></li><li><a href=/blogs class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">Blog</a></li><li><a href=/#courses class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">Courses</a></li><li><a href=/static/resume/HintonCV.pdf class="text-gray-300 hover:text-gray-200 px-4 py-2 flex items-center transition duration-150 ease-in-out">CV</a></li></ul></nav><div class=md:hidden x-data="{ expanded: false }"><button class=hamburger :class="{ 'active': expanded }" @click.stop="expanded = !expanded" aria-controls=mobile-nav :aria-expanded=expanded>
<span class=sr-only>Menu</span><svg class="w-6 h-6 fill-current text-gray-300 hover:text-gray-200 transition duration-150 ease-in-out" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect y="4" width="24" height="2" rx="1"/><rect y="11" width="24" height="2" rx="1"/><rect y="18" width="24" height="2" rx="1"/></svg></button><nav id=mobile-nav class="absolute top-full z-20 left-0 w-full px-4 sm:px-6 overflow-hidden transition-all duration-300 ease-in-out" x-ref=mobileNav :style="expanded ? 'max-height: ' + $refs.mobileNav.scrollHeight + 'px; opacity: 1' : 'max-height: 0; opacity: .8'" @click.away="expanded = false" @keydown.escape.window="expanded = false" x-cloak><ul class="bg-gray-800 px-4 py-2"><li><a href=/#books class="flex text-gray-300 hover:text-gray-200 py-2">Books</a></li><li><a href=/reviews class="flex text-gray-300 hover:text-gray-200 py-2">Reviews</a></li><li><a href=/tutorials class="flex text-gray-300 hover:text-gray-200 py-2">Tutorials</a></li><li><a href=/blogs class="flex text-gray-300 hover:text-gray-200 py-2">Blog</a></li><li><a href=/#courses class="flex text-gray-300 hover:text-gray-200 py-2">Courses</a></li><li><a href=/static/resume/HintonCV.pdf class="flex text-gray-300 hover:text-gray-200 py-2">CV</a></li></ul></nav></div></div></div></header><div class=flex-grow><div id=post-container class="content content-wider blog-post relative"><div class="section-header blog"><h1 class=title>Which Big City has the best Weather?</h1><p>6th July 2020</p><p>Python Plotting Preferred Weather</p></div><div><ul class="grid gap-6 w-full md:grid-cols-2" style=list-style:none;padding-left:0><li><input type=radio id=show-code name=code-toggle value=show-code class="hidden peer" onchange=clickCheckbox(this) required checked>
<label for=show-code class="inline-flex justify-between items-center p-5 w-full text-gray-500 bg-gray-800 rounded-lg border border-gray-200 cursor-pointer peer-checked:border-2 peer-checked:border-main-300 peer-checked:text-white peer-checked:bg-gray-700 hover:text-gray-200 hover:bg-gray-700"><div class="block w-full"><div class="w-full text-center text-lg font-semibold">Show me everything!</div><div class="w-full text-center text-sm">Oh yeah, coding time.</div></div></label></li><li><input type=radio id=hide-code name=code-toggle value=hide-code class="hidden peer" onchange=clickCheckbox(this)>
<label for=hide-code class="inline-flex justify-between items-center p-5 w-full text-gray-500 bg-gray-800 rounded-lg border border-gray-200 cursor-pointer peer-checked:border-2 peer-checked:border-main-300 peer-checked:text-white peer-checked:bg-gray-700 hover:text-gray-200 hover:bg-gray-700"><div class="block w-full"><div class="w-full text-center text-lg font-semibold">Just the plots</div><div class="w-full text-center text-sm">Code is nasty.</div></div></label></li></ul></div><script>function clickCheckbox(e){e.id=="show-code"?document.getElementById("post-container").classList.remove("hide-code"):document.getElementById("post-container").classList.add("hide-code")}</script><p>Like many people, I might one day be moving to the United States for work. However, I would like to know where I should move too. Where is too hot? Where is it too wet? Where is my little slice of paradise??</p><p>This is what we&rsquo;ll be making:</p><p><div><figure class=rounded><picture><source srcset=/tutorials/us_weather/2020-07-06-US_Weather_files/2020-07-06-US_Weather_1_0_hu6cfde4c074c43457cfd5ef85d45f50ca_1548284_1670x0_resize_q90_h2_box_3.webp width=1670 height=2406 type=image/webp><source srcset=/tutorials/us_weather/2020-07-06-US_Weather_files/2020-07-06-US_Weather_1_0.png width=1670 height=2406 type=image/png><img width=1670 height=2406 loading=lazy decoding=async alt=png src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mPMn7vLFAAFRgH97g1QygAAAABJRU5ErkJggg=="></picture></figure></div></p><p>So using the <a href="https://data.nodc.noaa.gov/cgi-bin/iso?id=gov.noaa.ncdc:C00516">NOAA Global Summary of the Day</a> and the <a href=https://en.wikipedia.org/wiki/List_of_United_States_cities_by_population>top 25 most populated cities in the US</a>, we&rsquo;ve got enough to make a plot.</p><p>But first, we have to smack this data format into something useable.</p><h2 id=data-preparation>Data preparation</h2><p>I downloaded the data from 2020-2013, and extract the list of a billion csv files into a directory per year. Ouch. We&rsquo;re going to have to pre-process this. Let&rsquo;s load in the list of cities first from <code>cities.csv</code>. <a href=/static/notebooks/us_weather/cities.csv>You can download that file here.</a></p><div class="reduced-code width-41" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff6ac1>import</span> os
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> pandas <span style=color:#ff6ac1>as</span> pd
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> numpy <span style=color:#ff6ac1>as</span> np
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> matplotlib.pyplot <span style=color:#ff6ac1>as</span> plt
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> matplotlib <span style=color:#ff6ac1>as</span> mpl
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> cmasher <span style=color:#ff6ac1>as</span> cmr
</span></span><span style=display:flex><span><span style=color:#ff6ac1>from</span> pathlib <span style=color:#ff6ac1>import</span> Path
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root <span style=color:#ff6ac1>=</span> Path(<span style=color:#5af78e>&#34;D:/data/weather/&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cities <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(root <span style=color:#ff6ac1>/</span> <span style=color:#5af78e>&#34;cities.csv&#34;</span>)
</span></span><span style=display:flex><span>cities<span style=color:#ff6ac1>.</span>head()
</span></span></code></pre></div></div><div><table class="table-auto table dataframe"><thead><tr style=text-align:right><th></th><th>name</th><th>lat</th><th>long</th></tr></thead><tbody><tr><th>0</th><td>New York</td><td>40.6635</td><td>-73.938700</td></tr><tr><th>1</th><td>Los Angeles</td><td>34.0194</td><td>-118.410800</td></tr><tr><th>2</th><td>Chicago</td><td>41.8376</td><td>-87.681800</td></tr><tr><th>3</th><td>Washington</td><td>38.9041</td><td>-77.017200</td></tr><tr><th>4</th><td>San Francisco</td><td>37.7775</td><td>-122.416389</td></tr></tbody></table></div><p>Then, lets find all the csv files for the US states and load them in.</p><p>Great. Now lets open one of the weather files as an example:</p><div class="expanded-code width-86" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>pd<span style=color:#ff6ac1>.</span>read_csv(root <span style=color:#ff6ac1>/</span> <span style=color:#5af78e>&#34;2020/71076099999.csv&#34;</span>)<span style=color:#ff6ac1>.</span>describe()<span style=color:#ff6ac1>.</span>T[[<span style=color:#5af78e>&#34;mean&#34;</span>, <span style=color:#5af78e>&#34;std&#34;</span>, <span style=color:#5af78e>&#34;min&#34;</span>, <span style=color:#5af78e>&#34;max&#34;</span>]]
</span></span></code></pre></div></div><div><table class="table-auto table dataframe"><thead><tr style=text-align:right><th></th><th>mean</th><th>std</th><th>min</th><th>max</th></tr></thead><tbody><tr><th>STATION</th><td>7.107610e+10</td><td>0.000000e+00</td><td>7.107610e+10</td><td>7.107610e+10</td></tr><tr><th>LATITUDE</th><td>5.956667e+01</td><td>1.282585e-13</td><td>5.956667e+01</td><td>5.956667e+01</td></tr><tr><th>LONGITUDE</th><td>-1.084833e+02</td><td>4.275283e-14</td><td>-1.084833e+02</td><td>-1.084833e+02</td></tr><tr><th>ELEVATION</th><td>3.180000e+02</td><td>0.000000e+00</td><td>3.180000e+02</td><td>3.180000e+02</td></tr><tr><th>TEMP</th><td>1.806011e+01</td><td>2.669257e+01</td><td>-3.280000e+01</td><td>6.630000e+01</td></tr><tr><th>TEMP_ATTRIBUTES</th><td>2.366854e+01</td><td>1.440817e+00</td><td>1.000000e+01</td><td>2.400000e+01</td></tr><tr><th>DEWP</th><td>7.848315e+00</td><td>2.382630e+01</td><td>-4.060000e+01</td><td>4.990000e+01</td></tr><tr><th>DEWP_ATTRIBUTES</th><td>2.361236e+01</td><td>1.461856e+00</td><td>1.000000e+01</td><td>2.400000e+01</td></tr><tr><th>SLP</th><td>1.017151e+03</td><td>1.084217e+01</td><td>9.926000e+02</td><td>1.048300e+03</td></tr><tr><th>SLP_ATTRIBUTES</th><td>2.366854e+01</td><td>1.440817e+00</td><td>1.000000e+01</td><td>2.400000e+01</td></tr><tr><th>STP</th><td>9.654730e+02</td><td>1.031018e+02</td><td>4.500000e+00</td><td>9.986000e+02</td></tr><tr><th>STP_ATTRIBUTES</th><td>2.366854e+01</td><td>1.440817e+00</td><td>1.000000e+01</td><td>2.400000e+01</td></tr><tr><th>VISIB</th><td>9.999000e+02</td><td>3.192211e-12</td><td>9.999000e+02</td><td>9.999000e+02</td></tr><tr><th>VISIB_ATTRIBUTES</th><td>0.000000e+00</td><td>0.000000e+00</td><td>0.000000e+00</td><td>0.000000e+00</td></tr><tr><th>WDSP</th><td>4.801685e+00</td><td>2.247471e+00</td><td>6.000000e-01</td><td>1.490000e+01</td></tr><tr><th>WDSP_ATTRIBUTES</th><td>2.366854e+01</td><td>1.440817e+00</td><td>1.000000e+01</td><td>2.400000e+01</td></tr><tr><th>MXSPD</th><td>8.594944e+00</td><td>3.352649e+00</td><td>1.900000e+00</td><td>1.810000e+01</td></tr><tr><th>GUST</th><td>5.808478e+02</td><td>4.868429e+02</td><td>1.500000e+01</td><td>9.999000e+02</td></tr><tr><th>MAX</th><td>3.051124e+01</td><td>2.678324e+01</td><td>-2.310000e+01</td><td>8.200000e+01</td></tr><tr><th>MIN</th><td>7.076404e+00</td><td>2.663468e+01</td><td>-4.320000e+01</td><td>5.450000e+01</td></tr><tr><th>PRCP</th><td>2.904494e-02</td><td>7.611089e-02</td><td>0.000000e+00</td><td>5.600000e-01</td></tr><tr><th>SNDP</th><td>4.333691e+02</td><td>4.848170e+02</td><td>8.000000e-01</td><td>9.999000e+02</td></tr><tr><th>FRSHTT</th><td>0.000000e+00</td><td>0.000000e+00</td><td>0.000000e+00</td><td>0.000000e+00</td></tr></tbody></table></div><p>Alright, so we have one csv file per year, per station. And what we&rsquo;d want to do is match stations within a certain lat/long distance to the city coordinate. Oh boy, this is going to take a while to run.</p><p>Let&rsquo;s write up something that goes through and just extracts station, lat, long, and then filters down to the stations we want. Im only going to use stations from 2020 (but they&rsquo;ll have data from other years).</p><div class="reduced-code width-55" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>station_locations <span style=color:#ff6ac1>=</span> root <span style=color:#ff6ac1>/</span> <span style=color:#5af78e>&#34;station_locations.csv&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># If Ive done this before, load in the previous results</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>if</span> os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>exists(station_locations):
</span></span><span style=display:flex><span>    station_df <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(station_locations)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#78787e># Or else figure it out from scratch using 2020 year</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>else</span>:
</span></span><span style=display:flex><span>    stations <span style=color:#ff6ac1>=</span> {}
</span></span><span style=display:flex><span>    y <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;2020&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>for</span> f <span style=color:#ff6ac1>in</span> os<span style=color:#ff6ac1>.</span>listdir(root <span style=color:#ff6ac1>/</span> y):
</span></span><span style=display:flex><span>        path <span style=color:#ff6ac1>=</span> root <span style=color:#ff6ac1>/</span> y <span style=color:#ff6ac1>/</span> f
</span></span><span style=display:flex><span>        cols <span style=color:#ff6ac1>=</span> [<span style=color:#5af78e>&#34;STATION&#34;</span>, <span style=color:#5af78e>&#34;LATITUDE&#34;</span>, <span style=color:#5af78e>&#34;LONGITUDE&#34;</span>]
</span></span><span style=display:flex><span>        res <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(path, nrows<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>, usecols<span style=color:#ff6ac1>=</span>cols)
</span></span><span style=display:flex><span>        stations[f<span style=color:#ff6ac1>.</span>replace(<span style=color:#5af78e>&#34;.csv&#34;</span>, <span style=color:#5af78e>&#34;&#34;</span>)] <span style=color:#ff6ac1>=</span> res
</span></span><span style=display:flex><span>    station_df <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>concat(<span style=color:#ff5c57>list</span>(stations<span style=color:#ff6ac1>.</span>values()))
</span></span><span style=display:flex><span>    station_df<span style=color:#ff6ac1>.</span>columns <span style=color:#ff6ac1>=</span> [<span style=color:#5af78e>&#34;station&#34;</span>, <span style=color:#5af78e>&#34;lat&#34;</span>, <span style=color:#5af78e>&#34;long&#34;</span>]
</span></span><span style=display:flex><span>    station_df<span style=color:#ff6ac1>.</span>to_csv(station_locations, index<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>)
</span></span></code></pre></div></div><p>Wow that took a long time to run. Lets save it out so we don&rsquo;t have to do that again. And then Im going to edit the code above to check that the <code>station_location.csv</code> doesn&rsquo;t exist, so this doesn&rsquo;t run whenever I start this notebook up.</p><div class="reduced-code width-35" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#78787e># Checking everything looks alright</span>
</span></span><span style=display:flex><span>station_df<span style=color:#ff6ac1>.</span>head()
</span></span></code></pre></div></div><div><table class="table-auto table dataframe"><thead><tr style=text-align:right><th></th><th>station</th><th>lat</th><th>long</th></tr></thead><tbody><tr><th>0</th><td>1001099999</td><td>70.933333</td><td>-8.666667</td></tr><tr><th>1</th><td>1001499999</td><td>59.791925</td><td>5.340850</td></tr><tr><th>2</th><td>1002099999</td><td>80.050000</td><td>16.250000</td></tr><tr><th>3</th><td>1003099999</td><td>77.000000</td><td>15.500000</td></tr><tr><th>4</th><td>1006099999</td><td>78.250000</td><td>22.816667</td></tr></tbody></table></div><p>Okay, first issue down. Now what we can do is filter that list to determine which stations are in the cities we care about. So we want a method to map a station to a city, if it is close enough</p><div class=width-62 markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>check_station</span>(row, threshold<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.1</span>):
</span></span><span style=display:flex><span>    station, lat, long, <span style=color:#ff6ac1>*</span>_ <span style=color:#ff6ac1>=</span> row
</span></span><span style=display:flex><span>    found <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>False</span>
</span></span><span style=display:flex><span>    distance <span style=color:#ff6ac1>=</span> (cities<span style=color:#ff6ac1>.</span>lat <span style=color:#ff6ac1>-</span> lat)<span style=color:#ff6ac1>**</span><span style=color:#ff9f43>2</span> <span style=color:#ff6ac1>+</span> (cities<span style=color:#ff6ac1>.</span>long <span style=color:#ff6ac1>-</span> long)<span style=color:#ff6ac1>**</span><span style=color:#ff9f43>2</span>
</span></span><span style=display:flex><span>    matches <span style=color:#ff6ac1>=</span> distance <span style=color:#ff6ac1>&lt;</span> threshold
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>if</span> matches<span style=color:#ff6ac1>.</span>sum():
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> cities[matches]<span style=color:#ff6ac1>.</span>name<span style=color:#ff6ac1>.</span>iloc[<span style=color:#ff9f43>0</span>]
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> np<span style=color:#ff6ac1>.</span>NaN
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#78787e># Lets test this works, we should get New York out</span>
</span></span><span style=display:flex><span>check_station((<span style=color:#5af78e>&#34;New York&#34;</span>, <span style=color:#ff9f43>40.6</span>, <span style=color:#ff6ac1>-</span><span style=color:#ff9f43>73.9</span>))
</span></span></code></pre></div></div><pre><code>'New York'
</code></pre><p>Fantastic. Now lets run it over all stations:</p><div class="reduced-code width-60" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>station_df[<span style=color:#5af78e>&#34;city&#34;</span>] <span style=color:#ff6ac1>=</span> station_df<span style=color:#ff6ac1>.</span>apply(check_station, axis<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span>final_stations <span style=color:#ff6ac1>=</span> station_df<span style=color:#ff6ac1>.</span>set_index(<span style=color:#5af78e>&#34;station&#34;</span>)<span style=color:#ff6ac1>.</span>dropna()
</span></span><span style=display:flex><span>final_stations<span style=color:#ff6ac1>.</span>head()
</span></span></code></pre></div></div><div><table class="table-auto table dataframe"><thead><tr style=text-align:right><th></th><th>lat</th><th>long</th><th>city</th></tr><tr><th>station</th><th></th><th></th><th></th></tr></thead><tbody><tr><th>71538099999</th><td>42.275556</td><td>-82.955556</td><td>Detroit</td></tr><tr><th>72011354829</th><td>42.543060</td><td>-83.178060</td><td>Detroit</td></tr><tr><th>72029153970</th><td>32.746940</td><td>-96.530560</td><td>Dallas</td></tr><tr><th>72030464752</th><td>40.100000</td><td>-75.266670</td><td>Philadelphia</td></tr><tr><th>72033493764</th><td>39.166670</td><td>-77.166670</td><td>Washington</td></tr></tbody></table></div><p>Great, so we&rsquo;ve got matching weather stations now. In fact, we have 91 of them! Now for the super slow part. For each of these stations, I want to go through and load in the csv files for all available years, keeping the city information preserved.</p><div class="expanded-code width-82" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>years <span style=color:#ff6ac1>=</span> [y <span style=color:#ff6ac1>for</span> y <span style=color:#ff6ac1>in</span> os<span style=color:#ff6ac1>.</span>listdir(root) <span style=color:#ff6ac1>if</span> os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>isdir(root <span style=color:#ff6ac1>/</span> y)]
</span></span><span style=display:flex><span>cols <span style=color:#ff6ac1>=</span> [<span style=color:#5af78e>&#34;STATION&#34;</span>, <span style=color:#5af78e>&#34;DATE&#34;</span>, <span style=color:#5af78e>&#34;MAX&#34;</span>, <span style=color:#5af78e>&#34;WDSP&#34;</span>, <span style=color:#5af78e>&#34;PRCP&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df_name <span style=color:#ff6ac1>=</span> root <span style=color:#ff6ac1>/</span> <span style=color:#5af78e>&#34;weather.csv&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>if</span> os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>exists(df_name):
</span></span><span style=display:flex><span>    df_weather <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(df_name)
</span></span><span style=display:flex><span><span style=color:#ff6ac1>else</span>:
</span></span><span style=display:flex><span>    dfs <span style=color:#ff6ac1>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>for</span> y <span style=color:#ff6ac1>in</span> years:
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>for</span> f <span style=color:#ff6ac1>in</span> os<span style=color:#ff6ac1>.</span>listdir(root <span style=color:#ff6ac1>/</span> y):
</span></span><span style=display:flex><span>            station <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>int</span>(f<span style=color:#ff6ac1>.</span>replace(<span style=color:#5af78e>&#34;.csv&#34;</span>, <span style=color:#5af78e>&#34;&#34;</span>))
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>if</span> station <span style=color:#ff6ac1>in</span> final_stations<span style=color:#ff6ac1>.</span>index:
</span></span><span style=display:flex><span>                df <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(root <span style=color:#ff6ac1>/</span> y <span style=color:#ff6ac1>/</span> f, usecols<span style=color:#ff6ac1>=</span>cols, parse_dates<span style=color:#ff6ac1>=</span>[<span style=color:#5af78e>&#34;DATE&#34;</span>])
</span></span><span style=display:flex><span>                df[<span style=color:#5af78e>&#34;city&#34;</span>] <span style=color:#ff6ac1>=</span> final_stations<span style=color:#ff6ac1>.</span>loc[station, <span style=color:#5af78e>&#34;city&#34;</span>]
</span></span><span style=display:flex><span>                dfs<span style=color:#ff6ac1>.</span>append(df)
</span></span><span style=display:flex><span>    df_weather <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>concat(dfs)<span style=color:#ff6ac1>.</span>reset_index(drop<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>True</span>)
</span></span><span style=display:flex><span>    df_weather<span style=color:#ff6ac1>.</span>to_csv(df_name, index<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>df_weather    
</span></span></code></pre></div></div><div><table class="table-auto table dataframe"><thead><tr style=text-align:right><th></th><th>STATION</th><th>DATE</th><th>WDSP</th><th>MAX</th><th>PRCP</th><th>city</th></tr></thead><tbody><tr><th>0</th><td>71538099999</td><td>2013-01-01</td><td>7.3</td><td>34.2</td><td>0.0</td><td>Detroit</td></tr><tr><th>1</th><td>71538099999</td><td>2013-01-02</td><td>5.8</td><td>30.2</td><td>0.0</td><td>Detroit</td></tr><tr><th>2</th><td>71538099999</td><td>2013-01-03</td><td>10.0</td><td>28.4</td><td>0.0</td><td>Detroit</td></tr><tr><th>3</th><td>71538099999</td><td>2013-01-04</td><td>14.8</td><td>30.2</td><td>0.0</td><td>Detroit</td></tr><tr><th>4</th><td>71538099999</td><td>2013-01-05</td><td>9.5</td><td>30.2</td><td>0.0</td><td>Detroit</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>426336</th><td>99849999999</td><td>2020-06-26</td><td>3.3</td><td>78.6</td><td>0.0</td><td>Chicago</td></tr><tr><th>426337</th><td>99849999999</td><td>2020-06-27</td><td>4.8</td><td>84.7</td><td>0.0</td><td>Chicago</td></tr><tr><th>426338</th><td>99849999999</td><td>2020-06-28</td><td>3.1</td><td>84.9</td><td>0.0</td><td>Chicago</td></tr><tr><th>426339</th><td>99849999999</td><td>2020-06-29</td><td>2.9</td><td>79.9</td><td>0.0</td><td>Chicago</td></tr><tr><th>426340</th><td>99849999999</td><td>2020-06-30</td><td>3.1</td><td>80.1</td><td>0.0</td><td>Chicago</td></tr></tbody></table><p>426341 rows × 6 columns</p></div><p>Alright, now we&rsquo;re getting somewhere, 225k rows! Except, oh boy, I can see that 999 is being used as a NaN value. Lets fix that up.</p><div class="expanded-code width-93" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#78787e># Yes it has all three variants -_-</span>
</span></span><span style=display:flex><span>df_weather <span style=color:#ff6ac1>=</span> df_weather<span style=color:#ff6ac1>.</span>replace(<span style=color:#ff9f43>999.9</span>, np<span style=color:#ff6ac1>.</span>NaN)<span style=color:#ff6ac1>.</span>replace(<span style=color:#ff9f43>99.99</span>, np<span style=color:#ff6ac1>.</span>NaN)<span style=color:#ff6ac1>.</span>replace(<span style=color:#ff9f43>9999.9</span>, np<span style=color:#ff6ac1>.</span>NaN)
</span></span><span style=display:flex><span>df_weather
</span></span></code></pre></div></div><div><table class="table-auto table dataframe"><thead><tr style=text-align:right><th></th><th>STATION</th><th>DATE</th><th>WDSP</th><th>MAX</th><th>PRCP</th><th>city</th></tr></thead><tbody><tr><th>0</th><td>71538099999</td><td>2013-01-01</td><td>7.3</td><td>34.2</td><td>0.0</td><td>Detroit</td></tr><tr><th>1</th><td>71538099999</td><td>2013-01-02</td><td>5.8</td><td>30.2</td><td>0.0</td><td>Detroit</td></tr><tr><th>2</th><td>71538099999</td><td>2013-01-03</td><td>10.0</td><td>28.4</td><td>0.0</td><td>Detroit</td></tr><tr><th>3</th><td>71538099999</td><td>2013-01-04</td><td>14.8</td><td>30.2</td><td>0.0</td><td>Detroit</td></tr><tr><th>4</th><td>71538099999</td><td>2013-01-05</td><td>9.5</td><td>30.2</td><td>0.0</td><td>Detroit</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>426336</th><td>99849999999</td><td>2020-06-26</td><td>3.3</td><td>78.6</td><td>0.0</td><td>Chicago</td></tr><tr><th>426337</th><td>99849999999</td><td>2020-06-27</td><td>4.8</td><td>84.7</td><td>0.0</td><td>Chicago</td></tr><tr><th>426338</th><td>99849999999</td><td>2020-06-28</td><td>3.1</td><td>84.9</td><td>0.0</td><td>Chicago</td></tr><tr><th>426339</th><td>99849999999</td><td>2020-06-29</td><td>2.9</td><td>79.9</td><td>0.0</td><td>Chicago</td></tr><tr><th>426340</th><td>99849999999</td><td>2020-06-30</td><td>3.1</td><td>80.1</td><td>0.0</td><td>Chicago</td></tr></tbody></table><p>426341 rows × 6 columns</p></div><h2 id=data-engineering>Data engineering</h2><p>The distinction here is that - at this point - we have a viable dataset which we can now manipulate as we see fit. We can create features and play around, but we have <em>right here</em> as a checkpoint. What I want to do is create a few <strong>features</strong> to determine what I would consider a good or bad day is. I&rsquo;ll be simple, and break this into <strong>temperature</strong> and <strong>weather</strong> features. And note that - as I don&rsquo;t really care what temperature it is during the night, I&rsquo;ll use the max temperature for everything.</p><p>I want to define two sliding scales, between -1 and 1, where -1 is a horrible cold day, and 1 is a horrible hot day. Aka hot and bad weather, or cold and bad weather. This is obviously <strong>entirely</strong> subjective, but what I&rsquo;ll do is this:</p><ul><li>&ldquo;Cold&rdquo; becomes normalised between -10C to 15C (14F to 59F)</li><li>&ldquo;Hot&rdquo; becomes normalised between 28C to 38C (83F to 100F)</li><li>Precipitation (in inches) is normalised between 0 and 1.5</li><li>Wind (in knots) is normalised between 0 and 20</li><li>Weather is the maximum between precipiation and wind</li></ul><p>We can see the distributions here:</p><div class="expanded-code width-93" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>df_weather[[<span style=color:#5af78e>&#34;MAX&#34;</span>, <span style=color:#5af78e>&#34;PRCP&#34;</span>, <span style=color:#5af78e>&#34;WDSP&#34;</span>]]<span style=color:#ff6ac1>.</span>hist(bins<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>100</span>, log<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>True</span>, layout<span style=color:#ff6ac1>=</span>(<span style=color:#ff9f43>1</span>, <span style=color:#ff9f43>3</span>), figsize<span style=color:#ff6ac1>=</span>(<span style=color:#ff9f43>10</span>, <span style=color:#ff9f43>4</span>));
</span></span></code></pre></div></div><p><div><figure class=rounded><picture><source srcset=/tutorials/us_weather/2020-07-06-US_Weather_files/2020-07-06-US_Weather_20_0_hu9792d8ff010b551acac6271eb694de07_41001_1658x0_resize_q90_h2_box_3.webp width=1658 height=746 type=image/webp><source srcset=/tutorials/us_weather/2020-07-06-US_Weather_files/2020-07-06-US_Weather_20_0.png width=1658 height=746 type=image/png><img width=1658 height=746 loading=lazy decoding=async alt=png src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mPMn7vLFAAFRgH97g1QygAAAABJRU5ErkJggg=="></picture></figure></div></p><p>So let&rsquo;s add in that feature:</p><div class="expanded-code width-107" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff6ac1>from</span> sklearn.preprocessing <span style=color:#ff6ac1>import</span> minmax_scale
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;cold&#34;</span>] <span style=color:#ff6ac1>=</span> minmax_scale(df_weather<span style=color:#ff6ac1>.</span>MAX<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff9f43>14</span>, <span style=color:#ff9f43>59</span>), (<span style=color:#ff6ac1>-</span><span style=color:#ff9f43>1</span>, <span style=color:#ff9f43>0</span>))
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;hot&#34;</span>] <span style=color:#ff6ac1>=</span> minmax_scale(df_weather<span style=color:#ff6ac1>.</span>MAX<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff9f43>83</span>, <span style=color:#ff9f43>100</span>), (<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1</span>))
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating_precip&#34;</span>] <span style=color:#ff6ac1>=</span> minmax_scale(df_weather<span style=color:#ff6ac1>.</span>PRCP<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1.5</span>), (<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1</span>))
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating_wind&#34;</span>] <span style=color:#ff6ac1>=</span> minmax_scale(df_weather<span style=color:#ff6ac1>.</span>PRCP<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>20</span>), (<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Combine the weather and temp ratings</span>
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating_weather&#34;</span>] <span style=color:#ff6ac1>=</span> df_weather[[<span style=color:#5af78e>&#34;rating_precip&#34;</span>, <span style=color:#5af78e>&#34;rating_wind&#34;</span>]]<span style=color:#ff6ac1>.</span>max(axis<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating_temp&#34;</span>] <span style=color:#ff6ac1>=</span> df_weather<span style=color:#ff6ac1>.</span>cold <span style=color:#ff6ac1>+</span> df_weather<span style=color:#ff6ac1>.</span>hot <span style=color:#ff6ac1>+</span> <span style=color:#ff9f43>0.001</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Make some little feature to represent our total rating</span>
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating&#34;</span>] <span style=color:#ff6ac1>=</span> np<span style=color:#ff6ac1>.</span>sign(df_weather<span style=color:#ff6ac1>.</span>rating_temp) <span style=color:#ff6ac1>*</span> df_weather<span style=color:#ff6ac1>.</span>rating_weather <span style=color:#ff6ac1>+</span> df_weather<span style=color:#ff6ac1>.</span>rating_temp
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating&#34;</span>] <span style=color:#ff6ac1>=</span> minmax_scale(df_weather[<span style=color:#5af78e>&#34;rating&#34;</span>]<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff6ac1>-</span><span style=color:#ff9f43>1</span>, <span style=color:#ff9f43>1</span>))
</span></span></code></pre></div></div><pre><code>D:\anaconda3\lib\site-packages\pandas\core\series.py:679: RuntimeWarning: invalid value encountered in sign
  result = getattr(ufunc, method)(*inputs, **kwargs)
</code></pre><div class=width-66 markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>ax <span style=color:#ff6ac1>=</span> df_weather[<span style=color:#5af78e>&#34;rating&#34;</span>]<span style=color:#ff6ac1>.</span>hist(bins<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>100</span>, log<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>True</span>, figsize<span style=color:#ff6ac1>=</span>(<span style=color:#ff9f43>8</span>, <span style=color:#ff9f43>4</span>))
</span></span><span style=display:flex><span>ax<span style=color:#ff6ac1>.</span>set_xlabel(<span style=color:#5af78e>&#34;Rating&#34;</span>), ax<span style=color:#ff6ac1>.</span>set_ylabel(<span style=color:#5af78e>&#34;Frequency&#34;</span>);
</span></span></code></pre></div></div><p><div><figure class=rounded><picture><source srcset=/tutorials/us_weather/2020-07-06-US_Weather_files/2020-07-06-US_Weather_23_0_hu87579f13415d18b2d6e9d275f80ddab7_23454_1387x0_resize_q90_h2_box_3.webp width=1387 height=742 type=image/webp><source srcset=/tutorials/us_weather/2020-07-06-US_Weather_files/2020-07-06-US_Weather_23_0.png width=1387 height=742 type=image/png><img width=1387 height=742 loading=lazy decoding=async alt=png src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mPMn7vLFAAFRgH97g1QygAAAABJRU5ErkJggg=="></picture></figure></div></p><p>Obiously <strong>this is all completely dependent on arbitrary choices on weather</strong>. Let&rsquo;s not get caught up on that. We can come back to this feature later if we need. For now, we want to take all the datapoints we have and take the average for each day in the year.</p><div class=width-68 markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;day&#34;</span>] <span style=color:#ff6ac1>=</span> df_weather<span style=color:#ff6ac1>.</span>DATE<span style=color:#ff6ac1>.</span>dt<span style=color:#ff6ac1>.</span>dayofyear
</span></span><span style=display:flex><span>df <span style=color:#ff6ac1>=</span> df_weather<span style=color:#ff6ac1>.</span>groupby([<span style=color:#5af78e>&#34;city&#34;</span>, <span style=color:#5af78e>&#34;day&#34;</span>])<span style=color:#ff6ac1>.</span>rating<span style=color:#ff6ac1>.</span>mean()<span style=color:#ff6ac1>.</span>reset_index()
</span></span><span style=display:flex><span>df
</span></span></code></pre></div></div><div><table class="table-auto table dataframe"><thead><tr style=text-align:right><th></th><th>city</th><th>day</th><th>rating</th></tr></thead><tbody><tr><th>0</th><td>Atlanta</td><td>1</td><td>0.411146</td></tr><tr><th>1</th><td>Atlanta</td><td>2</td><td>0.349296</td></tr><tr><th>2</th><td>Atlanta</td><td>3</td><td>0.442816</td></tr><tr><th>3</th><td>Atlanta</td><td>4</td><td>0.491880</td></tr><tr><th>4</th><td>Atlanta</td><td>5</td><td>0.398219</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td></tr><tr><th>10975</th><td>Washington</td><td>362</td><td>0.423438</td></tr><tr><th>10976</th><td>Washington</td><td>363</td><td>0.404648</td></tr><tr><th>10977</th><td>Washington</td><td>364</td><td>0.357907</td></tr><tr><th>10978</th><td>Washington</td><td>365</td><td>0.335265</td></tr><tr><th>10979</th><td>Washington</td><td>366</td><td>0.369574</td></tr></tbody></table><p>10980 rows × 3 columns</p></div><h2 id=make-the-plot>Make the plot</h2><p>Again we&rsquo;re going to run into the issue that we&rsquo;ve compressed two axes (temp and weather) down into one. Ah well, I&rsquo;m not going to publish this anyway!</p><p>First thing is I&rsquo;ll just sort cities based on their average rating, and pick a colorset. I&rsquo;m going to use a colormap from <code>cmasher</code> because I think it look great.</p><div class=width-74 markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>city_order <span style=color:#ff6ac1>=</span> df<span style=color:#ff6ac1>.</span>groupby(<span style=color:#5af78e>&#34;city&#34;</span>)<span style=color:#ff6ac1>.</span>rating<span style=color:#ff6ac1>.</span>mean()<span style=color:#ff6ac1>.</span>sort_values(ascending<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>)
</span></span><span style=display:flex><span>cmap <span style=color:#ff6ac1>=</span> plt<span style=color:#ff6ac1>.</span>get_cmap(<span style=color:#5af78e>&#39;cmr.fusion_r&#39;</span>)
</span></span></code></pre></div></div><p>And then away we go plotting!</p><div class="expanded-code width-114" markdown=1><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#78787e># Get a nice dark figure</span>
</span></span><span style=display:flex><span>bg <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;#111111&#34;</span>
</span></span><span style=display:flex><span>plt<span style=color:#ff6ac1>.</span>style<span style=color:#ff6ac1>.</span>use(<span style=color:#5af78e>&#34;dark_background&#34;</span>)
</span></span><span style=display:flex><span>fig, axes <span style=color:#ff6ac1>=</span> plt<span style=color:#ff6ac1>.</span>subplots(ncols<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>5</span>, nrows<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>6</span>, figsize<span style=color:#ff6ac1>=</span>(<span style=color:#ff9f43>10</span>, <span style=color:#ff9f43>12</span>))
</span></span><span style=display:flex><span>fig<span style=color:#ff6ac1>.</span>patch<span style=color:#ff6ac1>.</span>set_facecolor(bg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Make donut plots</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>for</span> (city, avg), ax <span style=color:#ff6ac1>in</span> <span style=color:#ff5c57>zip</span>(city_order<span style=color:#ff6ac1>.</span>iteritems(), axes<span style=color:#ff6ac1>.</span>flatten()):
</span></span><span style=display:flex><span>    df_tmp <span style=color:#ff6ac1>=</span> df[df<span style=color:#ff6ac1>.</span>city <span style=color:#ff6ac1>==</span> city]
</span></span><span style=display:flex><span>    xs <span style=color:#ff6ac1>=</span> np<span style=color:#ff6ac1>.</span>ones(df_tmp<span style=color:#ff6ac1>.</span>shape[<span style=color:#ff9f43>0</span>])
</span></span><span style=display:flex><span>    colors <span style=color:#ff6ac1>=</span> [cmap(<span style=color:#ff9f43>0.95</span> <span style=color:#ff6ac1>*</span> r) <span style=color:#ff6ac1>for</span> r <span style=color:#ff6ac1>in</span> df_tmp<span style=color:#ff6ac1>.</span>rating]
</span></span><span style=display:flex><span>    ws, ts <span style=color:#ff6ac1>=</span> ax<span style=color:#ff6ac1>.</span>pie(xs, colors<span style=color:#ff6ac1>=</span>colors, counterclock<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, startangle<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>90</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e># Set the line for each wedge to stop artifacts</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>for</span> w, c <span style=color:#ff6ac1>in</span> <span style=color:#ff5c57>zip</span>(ws, colors):
</span></span><span style=display:flex><span>        w<span style=color:#ff6ac1>.</span>set_linewidth(<span style=color:#ff9f43>0.5</span>)
</span></span><span style=display:flex><span>        w<span style=color:#ff6ac1>.</span>set_edgecolor(c)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    ax<span style=color:#ff6ac1>.</span>set_title(city, pad<span style=color:#ff6ac1>=-</span><span style=color:#ff9f43>2</span>)
</span></span><span style=display:flex><span>    ax<span style=color:#ff6ac1>.</span>set_aspect(<span style=color:#5af78e>&#39;equal&#39;</span>, <span style=color:#5af78e>&#39;box&#39;</span>)
</span></span><span style=display:flex><span>    ax<span style=color:#ff6ac1>.</span>add_artist(plt<span style=color:#ff6ac1>.</span>Circle((<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>0</span>), <span style=color:#ff9f43>.6</span>, color<span style=color:#ff6ac1>=</span>bg))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#78787e># Add average rating color circle</span>
</span></span><span style=display:flex><span>    ax<span style=color:#ff6ac1>.</span>add_artist(plt<span style=color:#ff6ac1>.</span>Circle((<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>0</span>), <span style=color:#ff9f43>.2</span>, color<span style=color:#ff6ac1>=</span>cmap(avg)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Add the custom colorbar</span>
</span></span><span style=display:flex><span>fig<span style=color:#ff6ac1>.</span>subplots_adjust(top<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.83</span>, bottom<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.04</span>)
</span></span><span style=display:flex><span>cbar_ax <span style=color:#ff6ac1>=</span> fig<span style=color:#ff6ac1>.</span>add_axes([<span style=color:#ff9f43>0.2</span>, <span style=color:#ff9f43>0.9</span>, <span style=color:#ff9f43>0.6</span>, <span style=color:#ff9f43>0.015</span>])
</span></span><span style=display:flex><span>cbar_ax<span style=color:#ff6ac1>.</span>set_title(<span style=color:#5af78e>&#34;Yearly weather trends for major US cities&#34;</span>, pad<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>25</span>, fontsize<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>18</span>)
</span></span><span style=display:flex><span>cb <span style=color:#ff6ac1>=</span> mpl<span style=color:#ff6ac1>.</span>colorbar<span style=color:#ff6ac1>.</span>ColorbarBase(cbar_ax, cmap<span style=color:#ff6ac1>=</span>cmap, orientation<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;horizontal&#39;</span>, 
</span></span><span style=display:flex><span>                               ticks<span style=color:#ff6ac1>=</span>[<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>0.25</span>, <span style=color:#ff9f43>0.5</span>, <span style=color:#ff9f43>0.75</span>, <span style=color:#ff9f43>1</span>])
</span></span><span style=display:flex><span>cb<span style=color:#ff6ac1>.</span>outline<span style=color:#ff6ac1>.</span>set_visible(<span style=color:#ff6ac1>False</span>)
</span></span><span style=display:flex><span>cb<span style=color:#ff6ac1>.</span>ax<span style=color:#ff6ac1>.</span>set_xticklabels([<span style=color:#5af78e>&#34;Cold and/or </span><span style=color:#5af78e>\n</span><span style=color:#5af78e>Bad Weather&#34;</span>, <span style=color:#5af78e>&#34;Chilly&#34;</span>, <span style=color:#5af78e>&#34;Feeling good&#34;</span>, <span style=color:#5af78e>&#34;Warm&#34;</span>, <span style=color:#5af78e>&#34;Hot and/or</span><span style=color:#5af78e>\n</span><span style=color:#5af78e>Bad Weather&#34;</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># And add our annotations</span>
</span></span><span style=display:flex><span>plt<span style=color:#ff6ac1>.</span>annotate(<span style=color:#5af78e>&#39;Using completely arbitrary temperature preferences&#39;</span>, 
</span></span><span style=display:flex><span>                    (<span style=color:#ff9f43>0.5</span>,<span style=color:#ff9f43>1</span>), (<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>15</span>), xycoords<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;axes fraction&#39;</span>, color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#a19a92&#34;</span>,
</span></span><span style=display:flex><span>                    textcoords<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;offset points&#39;</span>, size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>10</span>, va<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;top&#39;</span>, ha<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;center&#34;</span>)
</span></span><span style=display:flex><span>plt<span style=color:#ff6ac1>.</span>annotate(<span style=color:#5af78e>&#39;Source: NOAA (https://data.nodc.noaa.gov/cgi-bin/iso?id=gov.noaa.ncdc:C00516)&#39;</span>, 
</span></span><span style=display:flex><span>                    (<span style=color:#ff9f43>0.5</span>,<span style=color:#ff9f43>0.024</span>), (<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>0</span>), xycoords<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;figure fraction&#39;</span>, color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#a19a92&#34;</span>,
</span></span><span style=display:flex><span>                    textcoords<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;offset points&#39;</span>, size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>10</span>, va<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;bottom&#39;</span>, ha<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;center&#34;</span>)
</span></span></code></pre></div></div><p><div><figure class="img-large rounded"><picture><source srcset=/tutorials/us_weather/2020-07-06-US_Weather_files/2020-07-06-US_Weather_29_0_hu70f6b74a47c121e6a3bff804d1dbb732_1534749_1590x0_resize_q90_h2_box_3.webp width=1590 height=2326 type=image/webp><source srcset=/tutorials/us_weather/2020-07-06-US_Weather_files/2020-07-06-US_Weather_29_0.png width=1590 height=2326 type=image/png><img width=1590 height=2326 loading=lazy decoding=async alt=png src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mPMn7vLFAAFRgH97g1QygAAAABJRU5ErkJggg=="></picture></figure></div></p><p>There we go! Its not perfect, but I think it&rsquo;s pretty, and certainly San Jose is looking like a real nice place to go! And lets not go live in Phoenix. I don&rsquo;t know if its just stupidly hot or theres bad weather as well (a failing of the plot I admit), either way - nope.</p><p><div><figure class="img-main remove rounded"><picture><source srcset=/tutorials/us_weather/cover_hu0c4aecce4ff5a4bb5a874c8e64b46d3b_287341_1000x0_resize_q90_h2_box_3.webp width=1000 height=650 type=image/webp><source srcset=/tutorials/us_weather/cover.png width=1000 height=650 type=image/png><img width=1000 height=650 loading=lazy decoding=async alt=png src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mPMn7vLFAAFRgH97g1QygAAAABJRU5ErkJggg=="></picture></figure></div></p><hr><p>For your convenience, here&rsquo;s the code in one block:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff6ac1>import</span> os
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> pandas <span style=color:#ff6ac1>as</span> pd
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> numpy <span style=color:#ff6ac1>as</span> np
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> matplotlib.pyplot <span style=color:#ff6ac1>as</span> plt
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> matplotlib <span style=color:#ff6ac1>as</span> mpl
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> cmasher <span style=color:#ff6ac1>as</span> cmr
</span></span><span style=display:flex><span><span style=color:#ff6ac1>from</span> pathlib <span style=color:#ff6ac1>import</span> Path
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root <span style=color:#ff6ac1>=</span> Path(<span style=color:#5af78e>&#34;D:/data/weather/&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cities <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(root <span style=color:#ff6ac1>/</span> <span style=color:#5af78e>&#34;cities.csv&#34;</span>)
</span></span><span style=display:flex><span>cities<span style=color:#ff6ac1>.</span>head()
</span></span><span style=display:flex><span>pd<span style=color:#ff6ac1>.</span>read_csv(root <span style=color:#ff6ac1>/</span> <span style=color:#5af78e>&#34;2020/71076099999.csv&#34;</span>)<span style=color:#ff6ac1>.</span>describe()<span style=color:#ff6ac1>.</span>T[[<span style=color:#5af78e>&#34;mean&#34;</span>, <span style=color:#5af78e>&#34;std&#34;</span>, <span style=color:#5af78e>&#34;min&#34;</span>, <span style=color:#5af78e>&#34;max&#34;</span>]]
</span></span><span style=display:flex><span>station_locations <span style=color:#ff6ac1>=</span> root <span style=color:#ff6ac1>/</span> <span style=color:#5af78e>&#34;station_locations.csv&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># If Ive done this before, load in the previous results</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>if</span> os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>exists(station_locations):
</span></span><span style=display:flex><span>    station_df <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(station_locations)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#78787e># Or else figure it out from scratch using 2020 year</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>else</span>:
</span></span><span style=display:flex><span>    stations <span style=color:#ff6ac1>=</span> {}
</span></span><span style=display:flex><span>    y <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;2020&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>for</span> f <span style=color:#ff6ac1>in</span> os<span style=color:#ff6ac1>.</span>listdir(root <span style=color:#ff6ac1>/</span> y):
</span></span><span style=display:flex><span>        path <span style=color:#ff6ac1>=</span> root <span style=color:#ff6ac1>/</span> y <span style=color:#ff6ac1>/</span> f
</span></span><span style=display:flex><span>        cols <span style=color:#ff6ac1>=</span> [<span style=color:#5af78e>&#34;STATION&#34;</span>, <span style=color:#5af78e>&#34;LATITUDE&#34;</span>, <span style=color:#5af78e>&#34;LONGITUDE&#34;</span>]
</span></span><span style=display:flex><span>        res <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(path, nrows<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>, usecols<span style=color:#ff6ac1>=</span>cols)
</span></span><span style=display:flex><span>        stations[f<span style=color:#ff6ac1>.</span>replace(<span style=color:#5af78e>&#34;.csv&#34;</span>, <span style=color:#5af78e>&#34;&#34;</span>)] <span style=color:#ff6ac1>=</span> res
</span></span><span style=display:flex><span>    station_df <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>concat(<span style=color:#ff5c57>list</span>(stations<span style=color:#ff6ac1>.</span>values()))
</span></span><span style=display:flex><span>    station_df<span style=color:#ff6ac1>.</span>columns <span style=color:#ff6ac1>=</span> [<span style=color:#5af78e>&#34;station&#34;</span>, <span style=color:#5af78e>&#34;lat&#34;</span>, <span style=color:#5af78e>&#34;long&#34;</span>]
</span></span><span style=display:flex><span>    station_df<span style=color:#ff6ac1>.</span>to_csv(station_locations, index<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>)
</span></span><span style=display:flex><span><span style=color:#78787e># Checking everything looks alright</span>
</span></span><span style=display:flex><span>station_df<span style=color:#ff6ac1>.</span>head()
</span></span><span style=display:flex><span><span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>check_station</span>(row, threshold<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.1</span>):
</span></span><span style=display:flex><span>    station, lat, long, <span style=color:#ff6ac1>*</span>_ <span style=color:#ff6ac1>=</span> row
</span></span><span style=display:flex><span>    found <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>False</span>
</span></span><span style=display:flex><span>    distance <span style=color:#ff6ac1>=</span> (cities<span style=color:#ff6ac1>.</span>lat <span style=color:#ff6ac1>-</span> lat)<span style=color:#ff6ac1>**</span><span style=color:#ff9f43>2</span> <span style=color:#ff6ac1>+</span> (cities<span style=color:#ff6ac1>.</span>long <span style=color:#ff6ac1>-</span> long)<span style=color:#ff6ac1>**</span><span style=color:#ff9f43>2</span>
</span></span><span style=display:flex><span>    matches <span style=color:#ff6ac1>=</span> distance <span style=color:#ff6ac1>&lt;</span> threshold
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>if</span> matches<span style=color:#ff6ac1>.</span>sum():
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> cities[matches]<span style=color:#ff6ac1>.</span>name<span style=color:#ff6ac1>.</span>iloc[<span style=color:#ff9f43>0</span>]
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> np<span style=color:#ff6ac1>.</span>NaN
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#78787e># Lets test this works, we should get New York out</span>
</span></span><span style=display:flex><span>check_station((<span style=color:#5af78e>&#34;New York&#34;</span>, <span style=color:#ff9f43>40.6</span>, <span style=color:#ff6ac1>-</span><span style=color:#ff9f43>73.9</span>))
</span></span><span style=display:flex><span>station_df[<span style=color:#5af78e>&#34;city&#34;</span>] <span style=color:#ff6ac1>=</span> station_df<span style=color:#ff6ac1>.</span>apply(check_station, axis<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span>final_stations <span style=color:#ff6ac1>=</span> station_df<span style=color:#ff6ac1>.</span>set_index(<span style=color:#5af78e>&#34;station&#34;</span>)<span style=color:#ff6ac1>.</span>dropna()
</span></span><span style=display:flex><span>final_stations<span style=color:#ff6ac1>.</span>head()
</span></span><span style=display:flex><span>years <span style=color:#ff6ac1>=</span> [y <span style=color:#ff6ac1>for</span> y <span style=color:#ff6ac1>in</span> os<span style=color:#ff6ac1>.</span>listdir(root) <span style=color:#ff6ac1>if</span> os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>isdir(root <span style=color:#ff6ac1>/</span> y)]
</span></span><span style=display:flex><span>cols <span style=color:#ff6ac1>=</span> [<span style=color:#5af78e>&#34;STATION&#34;</span>, <span style=color:#5af78e>&#34;DATE&#34;</span>, <span style=color:#5af78e>&#34;MAX&#34;</span>, <span style=color:#5af78e>&#34;WDSP&#34;</span>, <span style=color:#5af78e>&#34;PRCP&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df_name <span style=color:#ff6ac1>=</span> root <span style=color:#ff6ac1>/</span> <span style=color:#5af78e>&#34;weather.csv&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>if</span> os<span style=color:#ff6ac1>.</span>path<span style=color:#ff6ac1>.</span>exists(df_name):
</span></span><span style=display:flex><span>    df_weather <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(df_name)
</span></span><span style=display:flex><span><span style=color:#ff6ac1>else</span>:
</span></span><span style=display:flex><span>    dfs <span style=color:#ff6ac1>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>for</span> y <span style=color:#ff6ac1>in</span> years:
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>for</span> f <span style=color:#ff6ac1>in</span> os<span style=color:#ff6ac1>.</span>listdir(root <span style=color:#ff6ac1>/</span> y):
</span></span><span style=display:flex><span>            station <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>int</span>(f<span style=color:#ff6ac1>.</span>replace(<span style=color:#5af78e>&#34;.csv&#34;</span>, <span style=color:#5af78e>&#34;&#34;</span>))
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>if</span> station <span style=color:#ff6ac1>in</span> final_stations<span style=color:#ff6ac1>.</span>index:
</span></span><span style=display:flex><span>                df <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>read_csv(root <span style=color:#ff6ac1>/</span> y <span style=color:#ff6ac1>/</span> f, usecols<span style=color:#ff6ac1>=</span>cols, parse_dates<span style=color:#ff6ac1>=</span>[<span style=color:#5af78e>&#34;DATE&#34;</span>])
</span></span><span style=display:flex><span>                df[<span style=color:#5af78e>&#34;city&#34;</span>] <span style=color:#ff6ac1>=</span> final_stations<span style=color:#ff6ac1>.</span>loc[station, <span style=color:#5af78e>&#34;city&#34;</span>]
</span></span><span style=display:flex><span>                dfs<span style=color:#ff6ac1>.</span>append(df)
</span></span><span style=display:flex><span>    df_weather <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>concat(dfs)<span style=color:#ff6ac1>.</span>reset_index(drop<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>True</span>)
</span></span><span style=display:flex><span>    df_weather<span style=color:#ff6ac1>.</span>to_csv(df_name, index<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>df_weather    
</span></span><span style=display:flex><span><span style=color:#78787e># Yes it has all three variants -_-</span>
</span></span><span style=display:flex><span>df_weather <span style=color:#ff6ac1>=</span> df_weather<span style=color:#ff6ac1>.</span>replace(<span style=color:#ff9f43>999.9</span>, np<span style=color:#ff6ac1>.</span>NaN)<span style=color:#ff6ac1>.</span>replace(<span style=color:#ff9f43>99.99</span>, np<span style=color:#ff6ac1>.</span>NaN)<span style=color:#ff6ac1>.</span>replace(<span style=color:#ff9f43>9999.9</span>, np<span style=color:#ff6ac1>.</span>NaN)
</span></span><span style=display:flex><span>df_weather
</span></span><span style=display:flex><span>df_weather[[<span style=color:#5af78e>&#34;MAX&#34;</span>, <span style=color:#5af78e>&#34;PRCP&#34;</span>, <span style=color:#5af78e>&#34;WDSP&#34;</span>]]<span style=color:#ff6ac1>.</span>hist(bins<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>100</span>, log<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>True</span>, layout<span style=color:#ff6ac1>=</span>(<span style=color:#ff9f43>1</span>, <span style=color:#ff9f43>3</span>), figsize<span style=color:#ff6ac1>=</span>(<span style=color:#ff9f43>10</span>, <span style=color:#ff9f43>4</span>));
</span></span><span style=display:flex><span><span style=color:#ff6ac1>from</span> sklearn.preprocessing <span style=color:#ff6ac1>import</span> minmax_scale
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;cold&#34;</span>] <span style=color:#ff6ac1>=</span> minmax_scale(df_weather<span style=color:#ff6ac1>.</span>MAX<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff9f43>14</span>, <span style=color:#ff9f43>59</span>), (<span style=color:#ff6ac1>-</span><span style=color:#ff9f43>1</span>, <span style=color:#ff9f43>0</span>))
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;hot&#34;</span>] <span style=color:#ff6ac1>=</span> minmax_scale(df_weather<span style=color:#ff6ac1>.</span>MAX<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff9f43>83</span>, <span style=color:#ff9f43>100</span>), (<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1</span>))
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating_precip&#34;</span>] <span style=color:#ff6ac1>=</span> minmax_scale(df_weather<span style=color:#ff6ac1>.</span>PRCP<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1.5</span>), (<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1</span>))
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating_wind&#34;</span>] <span style=color:#ff6ac1>=</span> minmax_scale(df_weather<span style=color:#ff6ac1>.</span>PRCP<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>20</span>), (<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>1</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Combine the weather and temp ratings</span>
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating_weather&#34;</span>] <span style=color:#ff6ac1>=</span> df_weather[[<span style=color:#5af78e>&#34;rating_precip&#34;</span>, <span style=color:#5af78e>&#34;rating_wind&#34;</span>]]<span style=color:#ff6ac1>.</span>max(axis<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating_temp&#34;</span>] <span style=color:#ff6ac1>=</span> df_weather<span style=color:#ff6ac1>.</span>cold <span style=color:#ff6ac1>+</span> df_weather<span style=color:#ff6ac1>.</span>hot <span style=color:#ff6ac1>+</span> <span style=color:#ff9f43>0.001</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Make some little feature to represent our total rating</span>
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating&#34;</span>] <span style=color:#ff6ac1>=</span> np<span style=color:#ff6ac1>.</span>sign(df_weather<span style=color:#ff6ac1>.</span>rating_temp) <span style=color:#ff6ac1>*</span> df_weather<span style=color:#ff6ac1>.</span>rating_weather <span style=color:#ff6ac1>+</span> df_weather<span style=color:#ff6ac1>.</span>rating_temp
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;rating&#34;</span>] <span style=color:#ff6ac1>=</span> minmax_scale(df_weather[<span style=color:#5af78e>&#34;rating&#34;</span>]<span style=color:#ff6ac1>.</span>clip(<span style=color:#ff6ac1>-</span><span style=color:#ff9f43>1</span>, <span style=color:#ff9f43>1</span>))
</span></span><span style=display:flex><span>ax <span style=color:#ff6ac1>=</span> df_weather[<span style=color:#5af78e>&#34;rating&#34;</span>]<span style=color:#ff6ac1>.</span>hist(bins<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>100</span>, log<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>True</span>, figsize<span style=color:#ff6ac1>=</span>(<span style=color:#ff9f43>8</span>, <span style=color:#ff9f43>4</span>))
</span></span><span style=display:flex><span>ax<span style=color:#ff6ac1>.</span>set_xlabel(<span style=color:#5af78e>&#34;Rating&#34;</span>), ax<span style=color:#ff6ac1>.</span>set_ylabel(<span style=color:#5af78e>&#34;Frequency&#34;</span>);
</span></span><span style=display:flex><span>df_weather[<span style=color:#5af78e>&#34;day&#34;</span>] <span style=color:#ff6ac1>=</span> df_weather<span style=color:#ff6ac1>.</span>DATE<span style=color:#ff6ac1>.</span>dt<span style=color:#ff6ac1>.</span>dayofyear
</span></span><span style=display:flex><span>df <span style=color:#ff6ac1>=</span> df_weather<span style=color:#ff6ac1>.</span>groupby([<span style=color:#5af78e>&#34;city&#34;</span>, <span style=color:#5af78e>&#34;day&#34;</span>])<span style=color:#ff6ac1>.</span>rating<span style=color:#ff6ac1>.</span>mean()<span style=color:#ff6ac1>.</span>reset_index()
</span></span><span style=display:flex><span>df
</span></span><span style=display:flex><span>city_order <span style=color:#ff6ac1>=</span> df<span style=color:#ff6ac1>.</span>groupby(<span style=color:#5af78e>&#34;city&#34;</span>)<span style=color:#ff6ac1>.</span>rating<span style=color:#ff6ac1>.</span>mean()<span style=color:#ff6ac1>.</span>sort_values(ascending<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>)
</span></span><span style=display:flex><span>cmap <span style=color:#ff6ac1>=</span> plt<span style=color:#ff6ac1>.</span>get_cmap(<span style=color:#5af78e>&#39;cmr.fusion_r&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#78787e># Get a nice dark figure</span>
</span></span><span style=display:flex><span>bg <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;#111111&#34;</span>
</span></span><span style=display:flex><span>plt<span style=color:#ff6ac1>.</span>style<span style=color:#ff6ac1>.</span>use(<span style=color:#5af78e>&#34;dark_background&#34;</span>)
</span></span><span style=display:flex><span>fig, axes <span style=color:#ff6ac1>=</span> plt<span style=color:#ff6ac1>.</span>subplots(ncols<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>5</span>, nrows<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>6</span>, figsize<span style=color:#ff6ac1>=</span>(<span style=color:#ff9f43>10</span>, <span style=color:#ff9f43>12</span>))
</span></span><span style=display:flex><span>fig<span style=color:#ff6ac1>.</span>patch<span style=color:#ff6ac1>.</span>set_facecolor(bg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Make donut plots</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>for</span> (city, avg), ax <span style=color:#ff6ac1>in</span> <span style=color:#ff5c57>zip</span>(city_order<span style=color:#ff6ac1>.</span>iteritems(), axes<span style=color:#ff6ac1>.</span>flatten()):
</span></span><span style=display:flex><span>    df_tmp <span style=color:#ff6ac1>=</span> df[df<span style=color:#ff6ac1>.</span>city <span style=color:#ff6ac1>==</span> city]
</span></span><span style=display:flex><span>    xs <span style=color:#ff6ac1>=</span> np<span style=color:#ff6ac1>.</span>ones(df_tmp<span style=color:#ff6ac1>.</span>shape[<span style=color:#ff9f43>0</span>])
</span></span><span style=display:flex><span>    colors <span style=color:#ff6ac1>=</span> [cmap(<span style=color:#ff9f43>0.95</span> <span style=color:#ff6ac1>*</span> r) <span style=color:#ff6ac1>for</span> r <span style=color:#ff6ac1>in</span> df_tmp<span style=color:#ff6ac1>.</span>rating]
</span></span><span style=display:flex><span>    ws, ts <span style=color:#ff6ac1>=</span> ax<span style=color:#ff6ac1>.</span>pie(xs, colors<span style=color:#ff6ac1>=</span>colors, counterclock<span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>False</span>, startangle<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>90</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e># Set the line for each wedge to stop artifacts</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>for</span> w, c <span style=color:#ff6ac1>in</span> <span style=color:#ff5c57>zip</span>(ws, colors):
</span></span><span style=display:flex><span>        w<span style=color:#ff6ac1>.</span>set_linewidth(<span style=color:#ff9f43>0.5</span>)
</span></span><span style=display:flex><span>        w<span style=color:#ff6ac1>.</span>set_edgecolor(c)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    ax<span style=color:#ff6ac1>.</span>set_title(city, pad<span style=color:#ff6ac1>=-</span><span style=color:#ff9f43>2</span>)
</span></span><span style=display:flex><span>    ax<span style=color:#ff6ac1>.</span>set_aspect(<span style=color:#5af78e>&#39;equal&#39;</span>, <span style=color:#5af78e>&#39;box&#39;</span>)
</span></span><span style=display:flex><span>    ax<span style=color:#ff6ac1>.</span>add_artist(plt<span style=color:#ff6ac1>.</span>Circle((<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>0</span>), <span style=color:#ff9f43>.6</span>, color<span style=color:#ff6ac1>=</span>bg))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#78787e># Add average rating color circle</span>
</span></span><span style=display:flex><span>    ax<span style=color:#ff6ac1>.</span>add_artist(plt<span style=color:#ff6ac1>.</span>Circle((<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>0</span>), <span style=color:#ff9f43>.2</span>, color<span style=color:#ff6ac1>=</span>cmap(avg)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Add the custom colorbar</span>
</span></span><span style=display:flex><span>fig<span style=color:#ff6ac1>.</span>subplots_adjust(top<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.83</span>, bottom<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>0.04</span>)
</span></span><span style=display:flex><span>cbar_ax <span style=color:#ff6ac1>=</span> fig<span style=color:#ff6ac1>.</span>add_axes([<span style=color:#ff9f43>0.2</span>, <span style=color:#ff9f43>0.9</span>, <span style=color:#ff9f43>0.6</span>, <span style=color:#ff9f43>0.015</span>])
</span></span><span style=display:flex><span>cbar_ax<span style=color:#ff6ac1>.</span>set_title(<span style=color:#5af78e>&#34;Yearly weather trends for major US cities&#34;</span>, pad<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>25</span>, fontsize<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>18</span>)
</span></span><span style=display:flex><span>cb <span style=color:#ff6ac1>=</span> mpl<span style=color:#ff6ac1>.</span>colorbar<span style=color:#ff6ac1>.</span>ColorbarBase(cbar_ax, cmap<span style=color:#ff6ac1>=</span>cmap, orientation<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;horizontal&#39;</span>, 
</span></span><span style=display:flex><span>                               ticks<span style=color:#ff6ac1>=</span>[<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>0.25</span>, <span style=color:#ff9f43>0.5</span>, <span style=color:#ff9f43>0.75</span>, <span style=color:#ff9f43>1</span>])
</span></span><span style=display:flex><span>cb<span style=color:#ff6ac1>.</span>outline<span style=color:#ff6ac1>.</span>set_visible(<span style=color:#ff6ac1>False</span>)
</span></span><span style=display:flex><span>cb<span style=color:#ff6ac1>.</span>ax<span style=color:#ff6ac1>.</span>set_xticklabels([<span style=color:#5af78e>&#34;Cold and/or </span><span style=color:#5af78e>\n</span><span style=color:#5af78e>Bad Weather&#34;</span>, <span style=color:#5af78e>&#34;Chilly&#34;</span>, <span style=color:#5af78e>&#34;Feeling good&#34;</span>, <span style=color:#5af78e>&#34;Warm&#34;</span>, <span style=color:#5af78e>&#34;Hot and/or</span><span style=color:#5af78e>\n</span><span style=color:#5af78e>Bad Weather&#34;</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># And add our annotations</span>
</span></span><span style=display:flex><span>plt<span style=color:#ff6ac1>.</span>annotate(<span style=color:#5af78e>&#39;Using completely arbitrary temperature preferences&#39;</span>, 
</span></span><span style=display:flex><span>                    (<span style=color:#ff9f43>0.5</span>,<span style=color:#ff9f43>1</span>), (<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>15</span>), xycoords<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;axes fraction&#39;</span>, color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#a19a92&#34;</span>,
</span></span><span style=display:flex><span>                    textcoords<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;offset points&#39;</span>, size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>10</span>, va<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;top&#39;</span>, ha<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;center&#34;</span>)
</span></span><span style=display:flex><span>plt<span style=color:#ff6ac1>.</span>annotate(<span style=color:#5af78e>&#39;Source: NOAA (https://data.nodc.noaa.gov/cgi-bin/iso?id=gov.noaa.ncdc:C00516)&#39;</span>, 
</span></span><span style=display:flex><span>                    (<span style=color:#ff9f43>0.5</span>,<span style=color:#ff9f43>0.024</span>), (<span style=color:#ff9f43>0</span>, <span style=color:#ff9f43>0</span>), xycoords<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;figure fraction&#39;</span>, color<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;#a19a92&#34;</span>,
</span></span><span style=display:flex><span>                    textcoords<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;offset points&#39;</span>, size<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>10</span>, va<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#39;bottom&#39;</span>, ha<span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;center&#34;</span>)
</span></span></code></pre></div><div class="relative max-w-xl mx-auto my-20"><div class="fancy_card horizontal"><div class=card_translator><div class="card_rotator tiny_rot card_layer"><div class="card_layer newsletter p-2"><div class="newsletter-inner h-full"><div class="relative h-full sib-form-container" id=sib-form-container><div class="mb-6 lg:mb-12 text-center"><h3 class="text-main-200 mb-2 lg:mb-8">Stay in the loop!</h3><p class="text-main-100 text-lg text-opacity-70">For new releases, exclusive giveaways, and reviews.</p></div><form action="https://Cosmiccoding.us5.list-manage.com/subscribe/post?u=aebe5de1d2e40dccb3aeca491&id=3987dd4a1f" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class="validate w-full" target=_blank novalidate><div><input type=email class="w-full appearance-none bg-main-600 mb-4 border border-main-600 bg-opacity-5 focus:border-main-300 rounded-sm px-4 py-3 text-main-100 placeholder-main-100 required" placeholder="Your best email…" aria-label="Your best email…" name=EMAIL required data-required=true id=EMAIL><div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_aebe5de1d2e40dccb3aeca491_3987dd4a1f tabindex=-1></div><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class="button btn bg-main-600 hover:bg-main-400 shadow w-full"></div><p id=mce-error-response style=display:none class="text-center mt-2 opacity-50 text-main-200">There was a problem, please try again.</p><p id=mce-success-response style=display:none class="text-center mt-2 opacity-50 text-main-200">Thanks mate, won't let ya down.</p></form></div></div></div><div class="card_layer card_effect card_soft_glare" style=pointer-events:none></div></div></div></div></div></div></div><script language=javascript type=text/javascript src=https://cosmiccoding.com.au/js/main.min.11673d10a962fb5205229607e62ea1d23424d35dad33db7bfe2a09a63d5409fa.js></script>
<script async defer src="https://www.googletagmanager.com/gtag/js?id=UA-72691106-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-72691106-1")</script></div></body></html>